# 5장. 지표 모니터링 및 경보 시스템

## 목표

지표 모니터링 및 경보 시스템을 설계하라.

- 인프라의 상태를 선명하게 볼 수 있도록 높은 가용성과 안정성을 달성하는데 중추적 역할

## 1단계. 문제 이해 및 설계 범위 확정

- 시스템 고객: 회사 내부용 시스템
- 수집 지표: 시스템 운영 지표
    - 저수준 운영체제 사용률 지표: CPU 부하, 메모리 사용률, 디스크 사용량
    - 고차원적 개념의 지표: RPS, 웹 서버 프로세스 개수
    - 사업 지표는 대상 아님
- 인프라 규모: DAU 1억 명, 1000개 서버 풀, 풀마다 100개 서버 하드웨어 유지
- 데이터 보존 기간: 1년 보관
- 장기 보관 전용 저장소 사용 시 지표 해상도 조정 여부
    - 새로 수집한 데이터: 7일 보관
    - 이후 데이터: 1분 단위 데이터로 만들어 30일 보관
    - 이후 데이터: 1시간 단위 데이터로 변환하여 보관
- 경보 채널: 이메일, 전화, 페이저듀티, 웹훅 등 지원
- 에러 로그, 엑세스 로그 수집 기능: 불필요
- 분산 시스템 추적 기능: 불필요

### 개략적 요구사항 및 가정

- 대규모 인프라 모니터링
    - DAU 1억명
    - 서버 풀 1000개, 풀당 서버 수 100개, 서버당 100개 운영 지표 수집 시 모니터링 대상 지표 수 == 천만 개
    - 데이터 보관 기간 1년
    - 그대로 보관: 7일, 1분 단위: 30일, 1시간 단위: 1년
- 모니터링 지표
    - CPU 사용률
    - 요청 수
    - 메모리 사용량
    - 메시지 큐 내의 메시지 수

### 비기능 요구사항

- 규모 확장성
- 낮은 응답 지연
- 안정성
- 유연성

### 비대상

- 로그 모니터링
- 분산 시스템 추적

## 2단계. 개략적 설계안 제시 및 동의 구하기

### 기본적 사항

- 데이터 수집
- 데이터 전송
- 데이터 저장소
- 경보
- 시각화

### 데이터 모델

- 통상 시계열 데이터 형태로 기록
    - 값 집합에 타임스탬프 붙은 형태
- 데이터 형태

  | 이름 | 자료형 |
    |-----|-------|
  | 지표 이름 | 문자열 |
  | 태그/레이블 집합 | <키:값> 쌍의 리스트 |
  | 지표 값 및 타임스탬프 배열 | <값, 타임스탬프> 쌍의 배열 |
- 데이터 접근 패턴
    - y축(시계열 데이터의 이름 및 레이블) - x축(시간)
- 쓰기 부하
    - 매일 천만 개 운영 지표 기록
    - 상당수의 지표는 발생 빈도도 높음
- 읽기 부하
    - 일시적으로 높음
    - 시각화와 경보 서비스

### 데이터 저장소 시스템

- 범용 데이터베이스는 이론적으로 시계열 데이터를 처리할 수 있지만, 설계안에서의 부하 규모 맞추려면 전문가 수준의 튜닝 필요
- 관게형 데이터베이스
    - 시계열 데이터 대상으로 통상적으로 수행하는 연산에 최적화 X
    - 시계열 데이터의 지수 이동 평균 지속 갱신 질의문 까다로움
    - 태그/레이블에 대한 질의를 지원하려면 태그마다 인덱스 지정 필요
    - 많은 양의 지속적인 쓰기 연산으로 성능 저하
- NoSQL
    - 시계열 데이터 처리 적합: 카산드라, 빅테이블
    - 확장이 용이한 스키마 설계 필요 -> NoSQL 데이터베이스 내부 구조에 대한 지식 필요
    - 범용 NoSQL 데이터베이스도 그다지 매력적 X
- **시계열 데이터에 최적화된 저장소 시스템**
    - 시계열 데이터 분석에 적합
    - SQL보다 사용하기 쉬운 질의 인터페이스 보유
    - 데이터 보관 기간 설정 및 데이터 집계 기능 제공
    - OpenTSDB: 분산 시계열 데이터베이스이지만 하둡과 HBase에 기반하고 있어 하둡/HBase 클러스터를 구성하고 운영해야 하므로 복잡
    - MetricsDB: X 사용
    - Timestream: 아마존 출시 제품
    - InfluxDB, Prometheus: 가장 인기 있는 시계열 데이터베이스
        - 다량의 시계열 데이터를 저장하고 빠른 실시간 분석 지원
        - 메모리 캐시와 디스크 저장소를 함께 사용
        - 영속성 요건과 높은 성능 요구사항 잘 만족

### 개략적 설계안

<img alt="image" src="https://github.com/user-attachments/assets/5520159b-fa14-4e87-8741-e7df138713a0">

## 3단계. 상셰 셜계

- 지표 수집
- 지표 전송 파이프라인의 규모 확장
- 질의 서비스
- 저장소 계층
- 경보 시스템
- 시각화 시스템

### 지표 수집

- 카운터나 CPU 사용량 같은 지표 수집 시 일부 데이터 소실은 큰 문제 아님
- 클라이언트는 데이터 전송 신뢰성 신경쓰지 않아도 됨

#### 풀 vs 푸시 모델

- 풀 모델
    - 주체: 지표 수집기
  - 예시: 프로메테우스
    - 지표 수집기는 데이터 가져올 서비스 목록 알아야 함
    - 지표 수집기 내에 모든 서비스 엔드포인트의 DNS/IP 정보 담은 파일 배치
    - 서버 추가/삭제에 유연하지 못함
        - 서비스 탐색 서비스(주키퍼 등)을 두고, 각 서비스는 자신의 가용성 관련 정보를 SDS에 기록
        - SDS는 서비스 엔드포인트 목록에 변화 생길 때마다 지표 수집기에 통보
        - SDS는 언제 어디서 지표를 수집하면 되는지 관련 정보를 기록
    - 동작 흐름
        1. 지표 수집대상 목록 확보 from SDS
            - 각 메타데이터에는 지표 수집 주기, IP 주소, 타임아웃, 재시도 인자 등이 기록
        2. HTTP 요청 보내어 지표 수집
        3. 지표 수집기는 서비스 엔드포인트 목록의 변화를 통지 받기 위한 변경 이벤트 알림 콜벡을 SDS 컴포넌트에 등록 or 폴링
    - 지표 수집기 다중 서버화
        - 데이터 중복 수집 방지 위해 중재 메커니즘 필요: 안전 해시링 사용
- 푸시 모델
    - 주체: 지표 출처
    - 예시: 클라우드와치, 그라파이트
    - 모니터링 대상 서버에 수집 에이전트라고 부르는 소프트웨어 설치
    - 수집 에이전트는 생산되는 지표 데이터를 받아 모은 다음 주기적으로 수집기에 전달
    - 데이터 집계: 수집기에 보내는 데이터 양 줄이는 효과적인 방법
    - 데이터 전송 트래픽의 양이 막대하여 수집기가 일시적으로 전송되는 데이터 처리 못해 오류 반환 시 에이전트는 내부 버퍼에 데이터 일시적으로 보관 후 재전송 가능
    - 에이전트에 위치한 서버 클러스터가 auto-scaling이 가능하도록 설정되어있으면 데이터 소실 가능
    - 푸시 모델을 채택한 지표 수집기가 지표 데이터를 제때 처리하지 못하는 일 방지 위해서는 지표 수집기 클러스터 자체도 CPU 부하에 따라 auto-scaling이 가능하도록 구성하고 앞에 로드밸런서를 두는
      것이 바람직
- 풀 vs 푸시

  |     | 풀 모델 | 푸시 모델 |
    |-----|--------|---------|
  | 손쉬운 디버깅| 애플리케이션 서버에 /metrics 엔드포인트 강제하므로 언제든 지표 데이터 조회 가능| |
  | 상태 진단 | 풀 요청에 응답하지 않는 순간 장애로 판단 가능 | 지표 수집기가 지표 받지 못하면 네트워크 장애 원인인지, 서버 장애 원인인지 알기 어려움 |
  | 생존 기간이 짧은 프로세스 | | 수집기가 지표를 끌어가기도 전에 종료되어버릴 수 있으므로 푸시 모델이 나음 (푸시 게이트웨이로 문제점 해결 가능) |
  | 방화벽 등의 복잡한 네트워크 구성 | 수집기 서버가 지표 데이터 제대로 끌어가려면 모든 /metrics 엔드포인트가 접근 가능하도록 구성해야 하므로 데이터센터를 여러 개 사용하는 경우 문제될 수 있음 | 지표 수집기가 로드 밸런서 및 auto-scaling 클러스터 형태로 구서오디어 있다면 어디서 오는 지표라도 수집 가능 |
  | 성능 | TCP | UDP |
  | 데이터 신빙성 | 지표 데이터를 가져올 애플리케이션 서버 목록이 이미 정의된 상태이므로 믿을 수 있음 | 아무나 보낼 수 있기 때문에 지표 전송 허용할 서버 목록을 수집기 측에 유지하거나 인증을 강제하여 문제 해결 |

### 지표 전송 파이프라인의 규모 확장

- 시계열 DB의 데이터 손싱 발생 가능
- 메시지 큐 - 소비자 두어 데이터 손실 방지
    - 카프카: 고도로 안정적, 규모 확장성 뛰어난 분산 메시지 플랫폼
    - 데이터 수집 컴포넌트와 처리 컴포넌트 사이 결합도 낮춤
    - 카프카에 데이터 보관하여 손실 방지

#### 카프카를 통한 규모 확장

- 대여폭 요구사항에 따라 파티션 수 설정
- 지표 이름에 따라 어떤 지표를 어느 파티션에 배치할지 결정하면 소비자는 지표 이름에 따라 데이터 집계 가능
- 태그/레이블 따라 지표 데이터를 세분화된 파티션으로 나눔
- 중요 지표가 먼저 처리될 수 있도록 지표 분리 및 우선순위 지정
- 카프카의 대안
    - 고릴라: 페이스북의 메모리 기반 시계열 데이터베이스 시스템
        - 일부 네트워크 장애에도 높은 수준의 쓰기 연산 가용성 유지
        - 메시지 큐 없이도 같은 수준의 안정성 제공 가능

### 데이터 집계 지점

- 수집 에이전트(on 클라이언트) vs 데이터 수집 파이프라인(before 저장소 기록) vs 질의 시점(after 저장소 기록)
- 수집 에이전트
    - 복잡한 집계 로직 지원 어려움
    - 카운터 값을 분 단위 집계하여 보내는 정도 가능
- 데이터 수집 파이프라인
  - 플링크 같은 스트림 프로세싱 엔진 필요
    - 데이터베이스에는 계산 결과만 기록하므로 저장 데이터양 줄어들 것
    - 늦게 도착하는 지표 데이터의 처리가 어렵고, 원본 데이터를 보관하지 않기 때문에 정밀도나 유연성 측면에서 손해
- 질의 시점
    - 질의 처리 순간에 전체 데이터를 대상으로 집계 결과 계산하므로 속도는 느릴 것

### 질의 서비스

- 질의 서버 클러스터 형태
- 시각화 또는 경보 시스템에서 접수된 요청을 시계열 데이터베이스를 통해 처리
- 질의 처리 전담 서비스 -> 클라이언트와 시계열 데이터베이스 사이 결합도 저하

#### 캐시 계층

- 캐시 서버를 도입하여 시계열 데이터베이스에 대한 질의 부하 낮추고, 질의 서비스 성능 높일 수 있음

#### 질의 서비스를 두면 곤란한 이유

- 대부분의 상용 시각화 및 경보 시스템은 시장에서 널리 사용되는 시계열 데이터베이스와의 연동을 처리하는 강력한 플로그인 이미 갖춤
- 별도 캐시 도입 필요 없는 시계열 DB도 있음

### 저장소 계층

#### 시계열 데이터베이스는 신중하게 선택할 것

- 페이스북 논문: 운영 데이터 저장소에 대한 질의 85%는 지난 26시간 내에 수집된 데이터 대상
- 이 사실을 잘 활용하는 시계열 데이터베이스를 골라 성능 측면에서 이점을 가져가자.

#### 저장 용량 최적화

- 데이터 인코딩 및 압축
    - 10초 만큼 다른 타임스탬프 하나를 온전히 표현하는데 32비트, 10을 표현하는데 4비트
    - 데이터를 완전한 형태로 저장하는 대신 기준 값과의 차이를 저장하자.
- 다운샘플링
    - 데이터 해상도를 낮춰 저장소 요구량 낮추자.
    - 요구사항) 초기 단위 -> 1분 -> 1시간
- 냉동 저장소
    - 잘 사용되지 않는 비활성 상태 데이터 보관
    - 비용 상대적 낮음

### 경보 시스템

1. 설정 파일을 가져와 캐시 서버에 보관
2. 경보 관리자는 설정 내역을 캐시에서 조회
3. 설정된 규칙에 근거하여 경보 관리자는 지정된 시간마다 질의 서비스 호출
    - 질의 결과가 설정된 임계값을 위반하면 경보 이벤트 생성
    - 경보 필터링, 병합, 중복 제거
    - 접근 제어: 사람의 실수로 빚어지는 장애를 박고 시스템 보안 유지 위해 특정 경보 관리 작업은 특정 개인만 처리할 수 있도록 제한
    - 재시도: 알림이 최소 한 번 전달됨을 보장
4. 경보 저장소는 카산드라 같은 형태의 키-값 저장소
    - 모든 경보 상태가 여기에 보관
    - 알림이 적어도 한 번 이상 전달되도록 보장
5. 경보 이벤트를 카프카에 전달
6. 경보 소비자는 카프카에서 경보 이벤트 조회
7. 경보 소비자는 카프카에서 읽은 경보 이벤트를 처리하여 각각의 채널로 알림 전송

#### 경보 시스템 - 만들 것인가 구매할 것인가

- 실무에서는 모두 구현하겠다는 아이디어 수용 어려움
- 본인 선택을 정당화할 수 있는 근거 필요

### 시각화 시스템

- 상용품만한 퀄리티의 시각화 시스템 구현은 어려움
- 예시) 그라파나

## 4단계. 마무리

<img alt="image" src="https://github.com/user-attachments/assets/c5b0640a-0e39-457f-b93c-2e4cb28e4fd5">
