# **처리율 제한 장치(Rate Limiter) 설계 요약**

## **1. 처리율 제한 장치 개요**
- **정의**: 클라이언트 또는 서비스가 보내는 요청 수를 일정 기간 동안 제한하는 시스템.
- **목적**:
    - **DoS 공격 방지**: 무분별한 요청으로 인한 리소스 고갈 방지.
    - **비용 절감**: API 사용량 제한을 통해 불필요한 비용 절약.
    - **서버 부하 방지**: 봇 트래픽 및 잘못된 사용자 패턴 차단.

---

## **2. 요구 사항**
- ### 상황에 따른 다른 설계가 나올 수 있으니 필요한 요구사항을 정하고 들어가자.
- **정확한 요청 제한**: 설정된 임계치를 초과하면 요청 차단.
- **낮은 응답 지연**: HTTP 응답 속도에 영향을 최소화.
- **메모리 효율성**: 최소한의 리소스로 운영.
- **분산 환경 지원**: 여러 서버에서 공유 가능.
- **예외 처리**: 차단된 요청에 대한 명확한 응답 제공.
- **높은 장애 내성**: 장애 발생 시 시스템 전체에 영향이 없도록 설계.

---

## **3. 처리율 제한 장치 배치**
- **클라이언트 측 배치**: 안정적인 제어가 어렵고 변조 가능성이 높음.
- **서버 측 배치**:
    - **API 서버 내부에서 제어**: 요청을 필터링하고 제한 적용.
    - **Middleware(미들웨어) 적용**: API 서버 앞단에서 트래픽을 조절.
    - **API Gateway 활용**: 처리율 제한, SSL 종료, 인증, IP 관리 등을 통합 제공.

---

## **4. 주요 처리율 제한 알고리즘**
### **1) 토큰 버킷(Token Bucket)**
- 일정 간격으로 버킷에 토큰을 추가하며, 요청 시 토큰을 사용.
- **장점**: 짧은 시간 동안 몰리는 트래픽 처리 가능.
- **단점**: 버킷 크기와 토큰 공급 속도 조정이 까다로움.

### **2) 누출 버킷(Leaky Bucket)**
- FIFO 큐를 사용하여 고정된 속도로 요청을 처리.
- **장점**: 안정적인 트래픽 흐름 유지.
- **단점**: 오래된 요청이 쌓이면 최신 요청이 버려질 가능성 있음.

### **3) 고정 윈도 카운터(Fixed Window Counter)**
- 일정 시간 간격(예: 1초, 1분)마다 요청 수를 카운트.
- **장점**: 구현이 간단하고 메모리 효율적.
- **단점**: 특정 시간 경계에서 요청이 몰릴 경우 한도를 초과할 위험.

### **4) 이동 윈도 로깅(Sliding Window Log)**
- 요청 타임스탬프를 저장하여 일정 기간 동안 요청 수를 계산.
- **장점**: 정확한 요청 제한 가능.
- **단점**: 타임스탬프 저장으로 인해 메모리 사용량이 높음.

### **5) 이동 윈도 카운터(Sliding Window Counter)**
- 과거 요청 수를 기반으로 요청 제한을 계산.
- **장점**: 부드러운 트래픽 제어, 메모리 효율적.
- **단점**: 과거 요청이 균등 분포한다고 가정하여 정확도가 낮을 수 있음.

---

## **5. 처리율 제한 장치의 저장소**
- **Redis 사용**: 빠른 카운터 관리 및 TTL 설정을 위해 사용.
- **명령어 활용**:
    - `INCR`: 카운터 증가.
    - `EXPIRE`: 일정 시간이 지나면 자동 삭제.

---

## **6. 분산 환경에서의 처리율 제한**
- **경쟁 조건(Race Condition) 해결**: Redis Lua Script 사용.
- **동기화 문제 해결**:
    - **Sticky Session**: 같은 클라이언트 요청을 같은 서버로 유도 (확장성 문제).
    - **중앙 집중형 데이터 저장소**: 모든 제한 정보를 Redis에서 관리.

---

## **7. 성능 최적화 및 모니터링**
- **성능 개선**:
    - **에지 서버 활용**: 사용자와 가까운 서버에서 처리율 제한 적용.
    - **이벤트 기반 일관성 모델(Eventual Consistency Model) 적용**.

- **모니터링**:
    - 설정된 처리율 제한이 효과적인지 검토.
    - 트래픽 패턴 변화 감지 및 알고리즘 조정.

---


## **결론**
처리율 제한 장치는 서비스 안정성과 비용 절감을 위해 필수적인 요소다. 다양한 알고리즘과 설계 방안을 활용하여 시스템에 적합한 솔루션을 구현해야 하며, 분산 환경에서의 동기화, 성능 최적화, 모니터링 등을 통해 지속적인 개선이 필요하다.
