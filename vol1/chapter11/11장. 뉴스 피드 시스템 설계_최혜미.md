# 11장. 뉴스 시스템 설계

## 1. 뉴스 시스템 개요

- **뉴스 피드 시스템**:
    - 사용자의 홈 페이지 중앙에 업데이트되는 목록 제공
    - 포함 내용: 사용자 상태 업데이트, 사진, 비디오, 링크, 앱 활동, 페이지/그룹의 좋아요 등
    - 대표 사례: 페이스북, 인스타그램, 트위터 등

## 2. 주요 기능 및 아키텍처 개요

- **피드 정렬 기준**:
    - 시간 역순, 토픽 포인트 순 등 다양한 방식 적용 가능

- **팬아웃(Fanout) 방식**:
    - **푸시 모델 (Write-time Fanout)**:
        - 새 포스팅 작성 시, 해당 사용자의 친구들의 뉴스 피드에 즉시 전송
        - **장점**: 뉴스 피드가 실시간으로 갱신되어 읽는 시간이 짧음
        - **단점**: 팔로워가 많은 경우(핫키 문제) 업데이트에 많은 리소스 소모
    - **풀 모델 (Read-time Fanout)**:
        - 피드를 읽는 시점에 필요한 포스팅을 실시간으로 가져옴
        - **장점**: 비활성 사용자나 자주 사용하지 않는 사용자에게 불필요한 작업 최소화, 핫키 문제 해소
        - **단점**: 피드 생성 시 지연 발생 가능
    - **혼합 모델**:
        - 대부분의 사용자에게는 Push 모델을 적용하고, 팔로워가 많은 유명인 등은 Pull 모델을 적용
        - 안정 해시를 통해 요청과 데이터를 고르게 분산하여 핫키 문제 완화

## 3. API 설계

- **피드 발행 API**:
    - `POST /v1/me/feed`
        - **본문**: 포스팅 내용
        - **인증 헤더**: API 호출 인증 값
    - **처리 과정**:
        1. 사용자가 피드 발행 API를 호출하여 새 포스팅 등록
        2. 로드밸런서가 트래픽 분산
        3. 웹 서버가 HTTP 요청을 내부 서비스로 중계
        4. 포스팅 저장 서비스가 DB와 캐시에 저장
        5. 포스팅 전송(팬아웃) 서비스가 친구들의 뉴스 피드에 푸시
        6. 알림 서비스가 친구들에게 새 포스팅 알림 전송

- **피드 읽기 API**:
    - `GET /v1/me/feed`
        - **인증 헤더**: API 호출 인증 값
    - **처리 과정**:
        1. 사용자가 피드 읽기 API를 호출
        2. 로드밸런서가 트래픽 분산
        3. 웹 서버가 뉴스 피드 서비스로 요청 전달
        4. 뉴스 피드 서비스가 캐시에서 피드 ID 목록 조회
        5. 필요한 사용자 정보 및 콘텐츠를 캐시에서 조회 후 JSON 형태로 응답

## 4. 상세 아키텍처 및 팬아웃 서비스

### 4.1 웹 서버의 역할
- 클라이언트와 통신
- 인증 및 처리율 제한 기능 수행
- HTTP 요청을 내부 서비스(포스팅 저장, 전송 서비스 등)로 중계

### 4.2 포스팅 전송(팬아웃) 서비스
- **푸시 모델 (쓰기 시점 팬아웃)**:
    - 새 포스팅이 기록되면 즉시 해당 사용자의 친구들의 뉴스 피드 캐시에 기록
    - **장점**: 실시간 갱신, 빠른 피드 읽기
    - **단점**: 친구 수가 많은 사용자의 경우 리소스 소모 과다(핫키 문제)
- **풀 모델 (읽기 시점 팬아웃)**:
    - 피드를 읽는 시점에 필요한 포스팅을 가져와 생성
    - **장점**: 불필요한 업데이트 작업 최소화, 리소스 절약
    - **단점**: 피드 생성에 시간이 소요되어 사용자 경험 저하 가능
- **혼합 접근 방식**:
    - 그래프 데이터베이스에서 친구 ID 목록 조회
    - 사용자 정보는 캐시에서 확인하며, 사용자 설정에 따라 업데이트 여부 결정
    - 포스팅 ID와 친구 목록 정보를 메시지 큐에 넣어 팬아웃 작업 서버가 처리
    - 뉴스 피드 캐시에는 `<postId, userId>` 형태의 매핑 정보만 저장 (메모리 효율)

### 4.3 피드 읽기 흐름
- 사용자가 피드 읽기 요청 → 로드밸런서 → 웹 서버 → 뉴스 피드 서비스
- 뉴스 피드 서비스가 캐시에서 포스팅 ID 목록 조회 → 추가 사용자 정보 및 콘텐츠 캐시에서 세부 데이터 조회 → JSON 응답

## 5. 캐시 구조

- **뉴스 피드 캐시**:
    - 뉴스 피드 ID 목록 저장
- **콘텐츠 캐시**:
    - 포스팅 데이터 및 인기 콘텐츠 저장
- **소셜 그래프 캐시**:
    - 사용자 간 관계 정보(팔로워, 팔로잉) 저장
- **행동 캐시**:
    - '좋아요', 댓글 등 사용자 행동 정보 저장
- **횟수 캐시**:
    - 좋아요 수, 댓글 수, 팔로워/팔로잉 수 등 통계 정보 저장

## 6. 추가 고려사항 및 확장 전략

- **데이터베이스 확장**:
    - Scale-up vs Scale-out
    - SQL vs NoSQL 선택
    - Master-Slave 다중화 및 복제본 읽기 분산
    - 일관성 모델 및 데이터베이스 샤딩
- **웹 계층**:
    - 무상태(Stateless)로 운영하여 확장성 확보
- **캐싱 전략**:
    - 가능한 많은 데이터를 캐시하여 DB 부하 감소
    - 캐시 미스 발생 시 신속한 처리 방안 마련
- **메시지 큐 활용**:
    - 컴포넌트 간 결합도 낮추기
    - 팬아웃 작업 시 안정적인 데이터 분산 보장
- **핵심 메트릭 모니터링**:
    - 트래픽이 몰리는 시간대의 QPS, 피드 새로고침 지연 시간 등
- **자동화된 처리율 제한**:
    - 처리율에 따라 Push와 Pull 모델 간 전환 고려

## 7. 결론

- 뉴스 시스템은 사용자가 친구 및 팔로워의 다양한 활동(포스팅, 사진, 비디오 등)을 실시간 또는 필요 시 확인할 수 있도록 설계되어야 함
- Push와 Pull 모델의 장단점을 고려한 혼합 접근 방식이 효과적임
- 일일 천만 방문자, 최대 5000명의 친구 지원 등 높은 트래픽과 대규모 데이터를 처리하기 위해 수평 확장, 캐시 최적화, 메시지 큐 활용 등이 필수적임
- 데이터베이스 확장 전략 및 모니터링 도구를 통해 시스템 안정성을 지속적으로 확보해야 함
