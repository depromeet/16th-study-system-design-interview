# 8장. URL 단축기 설계
## 목표
URL 단축기를 설계하라
## 1단계. 문제 이해 및 설계 범위 확정
- 트래픽 규모: 매일 1억 개의 단축 URL 생성 가능
- URL 길이: 짧을수록 좋음
- 문자 제한: [0-9, a-z, A-Z]
- 삭제/갱신 여부: 불가능
### 요구사항
- URL 단축
- URL 리다이렉션
- 높은 가용성과 규모 확장성, 장애 감내
### 개략적 추정
- 쓰기 연산: 매일 1억 개
- 초당 쓰기 연산: 1억/24/3600 = 1160회
- 읽기 연산:쓰기 연산 = 10:1
- 초당 읽기 연산: 11600회
- 10년간 운영: 1억 * 365 * 10 = 3560억 개 레코드 보관
- 축약 전 URL 평균 길이 = 100byte일 때 10년 간 필요한 저장 용량: 3560억 * 100byte = 36.5TB
## 2단계. 개략적 설계안 제시 및 동의 구하기
### a) API endpoint
- URL 단축
  - Http Method: POST
  - URI: /api/v1/data/shorten
  - 인자: {longURL: longURLstring}
  - 반환: 단축 URL
- URL 리다이렉션
  - HTTP Method: GET
  - URI: /api/v1/shortUrl
  - 반환: HTTP 리다이렉션 목적지 (원본 URL)
### b) URL redirection
- 동작 과정
  - GET `/api/v1/shortURL`
  - `301 Permanently Moved`, `Location: {원본 URL}`
    - 서버 부하 감소 -> `301 Permanently Moved`
    - 트래픽 분석 -> `302 Found`
  - GET {원본 URL}
> **301 Permanently Moved VS 302 Found**
> - 301 Permanently Moved: 영구적으로 이전되었다 == 브라우저가 응답 캐시 및 재활용
> - 302 Found: 일시적으로 이전되었다 == 항상 단축 URL 서버에 먼저 요청 후 리다이렉션
- 구현
  - 해시 테이블 <단축 URL, 원본 URL>
### c) URL 단축
- 해시 함수 요구사항
  - 해시 충돌 X
  - 원본 URL로 복원 가능
## 3단계. 상세 설계
### a) 데이터 모델
- 메모리 비용 측면에서 관계형 DB에 저장
- 칼럼: id, shortURL, longURL
### b) 해시 함수
- 해시 값 구성: [0-9, a-z, A-Z]
- 해시 값 길이: (10+26+26)^n >= 3650억, n=7
- 구현
  - 해시 후 충돌 해소
    - CRC32, MD5, SHA-1 등의 해시 함수 활용 시 해시 길이 > 7
    - 해결 방법: f(URL)의 첫 7글자만 이용하되, 충돌이 발생했을 때에는 해소될 때까지 f(URL+사전 정의 문자열)
    - 문제점: 해소될 될 때까지 한 번 이상 데이터베이스 질의 -> 블룸 필터 사용하여 개선
  - base-62 변환
    - 진법 변환: 수 표현 방식이 다른 두 시스템 간 같은 수 공유 시 유용
    - 62진법: 0=0, a=10, A=36
  - 비교
  
    | 해시 후 충돌 해소               | base-62                      |
    |---------------------|-------------------------|
    | 단축 URL 길이 고정          | 단축 URL 길이 가변     |
    | 유일성 보장 ID 생성기 불필요 | 유일성 보장 ID 생성기 필요      |
    | 충돌 해소 전략 필요 | 충돌 발생 X  |
    | ID 기반 X -> 다음 URL 예측 불가능 | ID 기반 -> 다음 URL 예측 가능 (보안상 문제) |

### c) URL 단축기 상세 설계
- base-62를 사용한 처리 흐름
  1. URL 입력
  2. 이미 존재하는 URL인지 DB 검사
  3. DB에 있다면, 해당 단축 URL 반환
  4. DB에 없다면, 유일 ID 생성 (ID = DB PK)
  5. 62진법 적용한 ID로 단축 URL 생성
  6. DB 저장 및 단축 URL 반환
- ID는 전역적 유일성 보장
### d) URL 리다이렉션 상세 설계

<img width="500" alt="image" src="https://github.com/user-attachments/assets/e9f1b3d9-bb24-4771-a8ee-204ff77ab275">

## 4단계. 마무리
### 추가 고려사항
- 처리율 제한 장치: IP 주소를 비롯한 필터링 규칙으로 요청 제한
- 웹 서버 규모 확장: 무상태 계층이므로, 규모 확장 용이
- 데이터베이스 규모 확장: 다중화, 샤딩을 활용한 규모 확장
- 데이터 분석 솔루션: 트래픽 분석
- 가용성, 데이터 일관성, 안정성
