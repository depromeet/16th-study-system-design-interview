# 1장. 근접성 서비스
## 목표
근접성 서비스를 설계하라.
- 음식점, 호텔 등 현재 위치에서 가까운 시설을 찾는데 이용

## 1단계. 문제 이해 및 설계 범위 확정
- 검색 반경 로직
  - 주어진 반경 내 사업장 대상
  - 사업장이 많지 않은 경우 어떻게 할지는 추후 논의
- 최대 허용 반경: 20km
- 사용자 반경 변경 여부: 0.5km, 1km, 2km, 5km, 20km 선택지 주어짐
- 사업장 정보 갱신 방법
  - 사업장 소유주가 사업장 정보를 시스템에 추가/삭제/갱신
  - 새로 추가/갱신된 정보는 다음날까지 반영
- 사용자 이동에 따른 화면 자동 갱신 여부: 고려 X
### 기능 요구사항
- 사용자의 위치와 검색 반경 정보에 매치되는 사업장 목록 반환
- 사업장 소유주가 사업장 정보를 추가/삭제/갱신 가능
- 바뀐 정보가 검색 결과에 실시간으로 반영될 필요는 없음
- 고객은 사업장의 상세 정보를 볼 수 있음
### 비기능 요구사항
- 낮은 응답 지연: 신속한 검색
- 데이터 보호: 데이터 사생활 보호 법안 준수
- 고가용성, 규모 확장성: 대규모 트래픽 감당
### 개략적 규모 추정
- DAU: 1억 명
- 등록 사업장 수: 2억 개
- QPS = 1억 * 5 / 10^5(= 24시간 * 60분 * 60초) = 5000
  - 한 사용자 당 하루 5회 검색 시도
## 2단계. 개략적 설계안 제시 및 동의 구하기
- API 설계
- 개략적 설계안
- 주변 사업장 검색 알고리즘
- 데이터 모델
### API 설계
`GET /v1/search/nearby`
- 검색 기준에 맞는 사업장 목록 반환
- 인자: latitude, longitude, radius
`GET /v1/businesses/:id`
- 특정 사업장 상세 정보 반환
`POST /v1/businesses`
- 새로운 사업장 추가
`PUT /v1/businesses/:id`
- 사업장 상세 정보 갱신
`DELETE /v1/businesses/:id`
- 특정 사업장 정보 삭제
### 데이터 모델
#### 읽기-쓰기 비율
- 읽기 연산: 빈번
  - 주변 사업장 검색
  - 사업장 정보 확인
- 쓰기 연산: 빈번 X
  - 사업장 정보 추가/삭제/갱신
#### 데이터 스키마
- business 테이블
  - 사업장 상세 정보 포함
  - 지리적 위치 색인 테이블: 위치 정보 관련 연산 효율성 높임
### 개략적 설계
- 위치 기반 서비스 / 사업장 관련 서비스로 구성

<img alt="image" src="https://github.com/user-attachments/assets/ce3c63a4-db60-465b-9b36-9b8f173eeb84">

### 주변 사업장 검색 알고리즘
- 지리적 위치 색인 지원 DB: Geohash in Redis, Postgres with PostGIS extension
#### 방안 1. 2차원 검색
- 반경으로 그린 원 안에 놓인 사업장 검색
```sql
SELECT business_id, latitude, longitude,
FROM business
WHERE (latitude BETWEEN {:my_lat} - radius AND {:my_lat} + radius)
  AND (longitude BETWEEN {:my_long} - radius AND {:my_long} + radius)
```
- full table scan이므로 비효율적
- 위도/경도 기준 인덱스 설정 -> 데이터가 2차원적이므로 두 데이터 집합을 추출하고, 교집합을 구해야 하므로 여전히 비효율적
  - 데이터베이스 색인으로는 **한 차원의 검색 속도만 개선**할 수 있다.
- 지리적 색인 만드는 방법 -> **지도를 작은 영역으로 분할하고 고속 검색이 가능하도록 색인을 만들자**
  1. 해시 기반 방안: 균등 격자, 지오해시, 카르테시안 계층 등
  2. 트리 기반 방안: 쿼드트리, 구글 S2, R-tree 등
#### 방안 2. 균등 격자
- 격자 또는 구획으로 나누는 접근법
- 단점
  - 사업장 분포가 균등하지 않다.
  - 주어진 격자의 인접 격자를 찾기 까다로울 수 있다.
#### 방안 3. 지오해시
- 2차원 위도 경도 데이터를 1차원의 문자열로 변환
- 비트를 하나씩 늘려가면서 재귀적으로 세계를 더 작은 격자로 분할
- 통상적으로 base32 표현법 사용
- 12단계의 정밀도: 지오해시 길이(레벨) = 격자 너비 * 높이 (레벨이 클수록 한 격자는 작아진다)
  - 최적의 정밀도 = 사용자 지정 반경으로 그린 원을 덮는 최소 크기 격자
- 격자 가장자리 관련 이슈: **지오해시는 해시값의 공통 접두어가 긴 격자들이 서로 더 가깝게 놓이도록 보장**
  1. 역은 참이 아니다: 가까운 두 위치가 어떤 공통 접두어도 갖지 않을 수 있다.
     - ex) 적도의 다른 쪽에 위치, 자오선상의 다른 반쪽에 위치
     - 단순 접두어 기반 SQL 질의문 사용 불가
       ```sql
       SELECT * FROM geohash_index WHERE geohash LIKE '9q8zn%'
       ```
  2. 두 지점의 공통 접두어 길이는 길지만 서로 다른 격자에 놓일 수 있다.
     - 해결책: 현재 격자를 비롯한 인접한 모든 격자으 ㅣ사업장 정보 조회
       - 특정 지오해시 주변 지오해시를 찾는 것은 O(1)
- 표시할 사업장이 충분하지 않다면?
  1. 주어진 반경 내 사업장만 반환: 부정적인 사용자 경험
  2. 검색 반경 확장
     - 지어해시 값의 마지막 비트 삭제하여 얻은 새 지오해시 값 사용해 주변 사업장 검색
#### 방안 4. 쿼드트리
- 격자 내용이 특정 기준 만족할 때까지 2차원 공간을 재귀적으로 사분면 분할하는데 사용되는 자료구조
- 질의에 답하는 데 사용될 트리 구조를 **메모리에** 만드는 것
- 즉, 각 LBS 서버에 존재해야 하며, 서버가 시작하는 시점에 구축
- 쿼드트리 전부를 저장하는 데 얼마나 많은 메모리가 필요한가?
  - 말단 노드에 수록되는 데이터
    - 격자 식별할 좌상단/우하단 꼭짓점 좌표 = 32 byte
    - 격자 내부 사업장 ID 목록: ID당 8 byte * 한 격자 당 허용 사업장 수 최대값 100
    - 총 832 byte
  - 내부 노드에 수록되는 데이터
    - 격자 식별할 좌상단/우하단 꼭짓점 좌표 = 32 byte
    - 하위 노드 4개를 가리킬 포인터: 32 byte
    - 총 64 byte
  - 필요한 총 메모리 사용량
    - 격자 내 최대 100개 사업장
    - 말단 노드 수 = 2억 / 100 = 2백만
    - 내부 노드 수 = 2백만 / 3 = 67만
    - 총 메모리 요규량 = 2백만 * 832 byte + 67만 * 64 byte = 1.71GB
    - 메모리를 많이 차지하지 않으므로, 서버 한 대로 충분하다. (물론 추후 읽기 연산 많아지면 부합 분산을 위해 증설 필요)
- 전체 쿼드트리 구축에 소요되는 시간
  - O((n/100)log(n/100)): 2억 개 사업장 정보 인덱싱하는 쿼드트리 구축에 몇 분 정도 소요 가능
- 쿼드트리로 주변 사업장을 검색하려면?
  1. 메모리에 쿼드트리 인덱스 구축
  2. 검색 시작점이 포함된 말단 노드를 만날 때까지 루트부터 탐색
     1. 해당 노드에 100개 사업장 있으면 해당 노드만 반환
     2. 아니라면, 충분한 사업장 수 확보될 때까지 인접 노드 추가
- 쿼드트리 운영 시 고려사항
  - 쿼드트리 구축으로 서버 시작 시간 길어짐: 배포 시 동시에 너무 많은 서버에 배포하지 않도록 유의
  - 쿼드트리 갱신: 점진적 갱신
#### 방안 5. 구글 S2
- 메모리 기반
- 지구를 힐베르트 곡선이라는 공간 채움 곡선을 사용하여 1차원 색인화하는 방안
- 힐베르트 곡선 상 인접한 두 지점은 색인화 이후 1차원 공간 내에서도 인접한 위치에 존재
- 구글, 틴더 등에서 널리 사용
- 장점
  - 임의 지역에 다양한 수준의 영역 지정 가능
  - 지오펜스 구현에 적합
    - 지오펜스: 실세계 지리적 영역에 설정한 가상의 경계
    - `특정 지점 반경 몇 km 이내`처럼 동적 지정 가능
    - 스쿨존, 동네 경계처럼 이미 존재한느 경계선 묶어 설정 가능
    - 단순 주변 검색보다 풍부한 기능 제공 가능
  - 영역 지정 알고리즘 제공
    - 고정 정밀도를 사용하는 대신 최소 수준, 최고 수준, 최대 셀 개수 등을 지정 가능
    - 셀 크기 유연하게 조정 가능, 반환 결과 더 상세
### 지오 해시 vs 쿼드 트리
| 지오해시      | 쿼드트리                                                                      |
|-----------|---------------------------------------------------------------------------|
| 구현, 사용 쉬움 | 구현 까다로움(트리 구축)                                                            |
| 지정 반경 내 사업장 검색 지원 | k번째로 가까운 사업장 목록까지 조회 가능, 하위 노드 분할 과정이 숫자 k에 기반하며 k개 찾을 때까지 검색 범위 자동 조정 가능 |
| 정밀도 고정 시 격자 크기 고정, 인구 밀도에 따라 동적으로 격자 크기 조정 불가 | 인구 밀도에 따라 격자 크기 동적 조정 가능 |
| 색인 갱신 쉬움 | 색인 갱신 까다로움 -> O(logN), 다중 스레드 환경에서는 락 사용 필요, 리밸런싱 필요할 경우 부하 증가 |
## 3단계. 상세 설계
- 데이터베이스 규모 확장
- 캐시
- 지역 및 가용성 구역
- 시간대 또는 사업장 유형에 따른 검색
- 최종 아키텍처 다이어그램
### 데이터베이스 규모 확장
#### 사업장 테이블
- 샤딩: 사업장 ID 기준
- 모든 샤드에 부하 고르게 분산, 운영적 측면에서도 관리 용이
#### 지리 정보 색인 테이블
- 지오해시 사용 가정
- 구성 방법
  1. 각 지오해시에 속한 모든 사업장 ID를 JSON 배열로 한 열에 보관
     - JSON 배열을 읽어 다음 갱신할 사업장 ID 찾아야 함
     - 새 사업장 등록 시 같은 사업장 정보 있는지 데이터 전부 탐색해야 함
     - 병렬로 실행되는 갱신 연산 결과로 데이터 손실 방지 위해 락 사용해야 함
  2. 같은 지오해시에 속한 사업장 ID를 별도 열로 저장
     - <지오 해시, 사업장 ID> 복합키를 사용하여 사업장 정보 추가/삭제 용이
#### 지리 정보 색인의 규모 확장
- 데이터 크기 자체는 서버 한 대로 충분히 수용 가능
- 읽기 연산 빈도 높다면, 여러 데이터베이스 서버로 부하 분산 필요
- 지오해시 테이블은 샤딩이 까다로우므로, 샤딩 대신 사본 DB 활용을 고려
### 캐시
- 캐시가 필요한가?
  - 처리 부하가 읽기 중심이고, 데이터베이스 크기는 상대적으로 작아서 모든 데이터를 한 대의 DB로 수용 가능
  - 질의문 처리 성능은 I/O에 좌우되지 않으므로 메모리 캐시 사용과 비슷
  - 일기 성능 병목은 사본 DB 증설하여 읽기 대여폭 늘릴 수 있음
  - 사업적 요구사항도 고려해야함
#### 캐시 키
- 사용자 위치 정보: 적절하지 않음
  - 단말에서 반환되는 위치 정보는 추정치이므로, 움직이지 않더라도 측정마다 조금씩 달라질 것
  - 사용자 이동에 따른 위도/경도 정보 변경 -> 대부분 애플리케이션에 무의미한 정보
- 지오해시, 쿼드트리는 같은 격자 내 모든 사업장이 같은 해시 값 갖도록 만들 수 있으므로 이 문제를 효과적으로 해결 가능
#### 캐시 데이터 유형
| key | value |
|-----|-------|
| 지오해시 | 해당 격자 내의 사업장 ID 목록 |
| 사업장 ID | 사업장 정보 객체 |
- 격자 내 사업장 ID
  - 사업장 정보 == 자주 변경 X
  - 지오해시에 해당하는 사업장 ID 목록 미리 계산해 키-값 저장소에 캐싱
  - 조회: 캐시 조회 후 없으면 DB 조회해서 캐시에 보관
  - 갱신: 캐시 항목 무효화
  - 4, 5, 6 레벨 정밀도 캐싱
  - 메모리 요구량
    - value: 8 byte * 2억 * 3가지 정밀도 = 5GB
    - 서버 한 대로 충분
  - 각 지역별 레디스 클러스터 위치: 고가용성, 전송 지연 방지 목적
#### 클라이언트 애플리케이션에 표시할 사업장 정보
| key         | value            |
|-------------|------------------|
| business_id | 사업장 이름, 주소, 사진 등 |
### 지역 및 가용성 구역
- 사용자와 시스템 사이의 물리적 거리 최소화
- 트래픽을 인구에 따라 고르게 분산하여 유연성 확보
- 지역에 맞는 사생활 보호법 준수하여 운영
### 시간대, 사업장 유형별 검색
- 지오해시나 쿼드트리 메커니즘으로 분할 시 겸색 결과로 얻어지는 사업장 수 상대적으로 적음
- 근처 사업장 ID 전부 확보한 후 필터링
### 최종 설계도
<img alt="image" src="https://github.com/user-attachments/assets/fd5fcfd2-6a5d-474b-8267-910a765da04c">