# 5장. 안정 해시 설계
수평적 규모 확장을 위해서는 요청 등을 서버에 균등하게 나눌 수 있어야 한다.
## 해시 키 재배치 문제
- 서버 4대 중 1대에 장애가 발생하여 동작을 중단했다면?
    - 사용하는 해시 함수: serverIndex = hash(key) % N(서버 개수)
    - 해시 값은 변하지 않아도, 서버 인덱스가 바뀔 것
    - 장애가 발생한 서버의 키 뿐만 아니라 대부분의 키가 재분배
## 안정 해시
- 해시 키 재배치 문제를 해결하기 위함
- 해시 테이블 크기가 조정될 때, 평균적으로 오직 k/n개의 키만 재배치하는 해시 기술
    - k = 키의 개수, n = 슬롯 개수
- 해시 공간: 해시 함수 f에 따라 사용 가능한 공간
- 해시 링: 해시 공간의 양쪽을 구부려 해시 링을 만든다.

<img width="500" alt="image" src="https://github.com/user-attachments/assets/0d44759c-9609-4d32-a8d2-be34e96a8f5c" />

- 해시 서버: 해시 함수 f를 사용하여 서버 IP나 이름을 이 링 위 어떤 위치에 대응시킬 수 있다.
- 해시 키: 키 또한 해시 링 위 어느 지점에 배치 가능
- 서버 조회: 어떤 키가 저장되는 서버는, 해당 키의 위치로부터 **시계 방향으로 링을 탐색해나가면서 만나는 첫번째 서버**
- 서버 추가: 해시 링 위에 새로운 서버가 추가된다면, 시계 방향으로 링을 탐색할 때 만나는 첫번째 서버가 달라지는 키만 재배치될 것이다.
- 서버 제거: 서버 추가와 같은 방식으로 키 재배치가 일어난다. 삭제된 서버와 그 반시계 방향에 있는 최초의 서버 사이에 있는 키가 재배치된다.
### 기본 구현법의 두 가지 문제
- 기본 절차
    - 서버와 키를 균등 분포 해시 함수를 사용해 해시 링에 배치한다.
    - 키의 위치에서 링을 시계 방향으로 탐색하다 만나는 최초의 서버가 키가 저장될 서버다.
- 문제점
    - 서버가 추가되거나 삭제되는 상황을 감안하면 파티션의 크기를 균등하게 유지하는 게 불가능
    - 키의 균등 분포를 당성하기 어려움

      <img width="500" alt="image" src="https://github.com/user-attachments/assets/ed7b2f4b-8427-44f8-9b38-e880f9918d3f" />

- 해결책: **가상 노드 (복제)**기법
### 가상 노드

<img width="500" alt="image" src="https://github.com/user-attachments/assets/a82df980-ed8b-4f36-be05-e983f64c297b" />

- 실제 노드 또는 서버를 가리키는 노드로서, 하나의 서버는 링 위에 여러 개의 가상 노드를 가질 수 있다.
- 각 서버는 하나가 아닌 여러 개의 파티션을 관리하게 된다.
- 가상 노드의 개수를 늘릴수록 
    - 키의 분표는 균등해진다.
    - 가상 노드 데이터를 저장할 공간은 더 많이 필요해진다.
- 가상 노드의 개수에는 **타협적 결정이 필요하다.**
## 마무리
- 서버 추가/삭제 시 재배치되는 키의 수를 최소화한다.
- 데이터가 균등하게 분포하게 되므로 수평적 규모 확장성을 달성하기 쉽다.
- 핫스팟 키 문제를 줄인다.
- 사용 예시
    - 아마존 다이나모 데이터베이스의 파티셔닝 관련 컴포넌트
    - 아파치 카산드라 클러스터에서의 데이터 파티셔닝
    - 디스코드 채팅 애플리케이션
    - 아카마이 CDN
    - 매그레프 네트워크 부하 분산기
