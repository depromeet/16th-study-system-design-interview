# **키-값 저장소 설계 요약**

## **1. 개요**
- **정의**: 키-값 저장소(Key-Value Store)는 비관계형 데이터베이스로, 각 값이 고유 식별자(키)에 의해 접근됨.
- **특징**:
    - 키는 **유일**해야 하며, 일반 텍스트나 해시 값이 될 수 있음.
    - 값은 문자열, 리스트, 객체 등 다양한 형태 가능.
    - 대표적인 키-값 저장소: **Amazon DynamoDB, Memcached, Redis**.

---

## **2. 설계 목표**
- **대용량 데이터 저장 가능**
- **높은 가용성(High Availability) 보장**
- **자동 확장(Scalability) 지원**
- **데이터 일관성 수준 조정 가능**
- **낮은 응답 지연(latency) 보장**

---

## **3. CAP 정리(Consistency, Availability, Partition Tolerance)**
**CAP 정리란?**
- **분산 시스템에서 일관성(Consistency), 가용성(Availability), 파티션 감내(Partition Tolerance) 세 가지 속성을 모두 동시에 만족할 수 없다는 이론**.
- **이 중 두 가지만 선택 가능**하며, 어떤 속성을 우선할 것인지에 따라 데이터 저장소의 특성이 달라짐.

### **1) 일관성(Consistency)**
- 모든 노드에서 같은 데이터를 볼 수 있도록 보장.
- 어떤 클라이언트가 데이터를 변경하면, **모든 노드가 즉시 동일한 값을 반환해야 함**.
- **일관성이 강할수록 최신 데이터를 제공하지만 응답 속도가 느려질 수 있음**.
- 은행 시스템과 같은 **강한 일관성이 필요한 경우 사용**.

### **2) 가용성(Availability)**
- **분산 시스템의 일부 노드에 장애가 발생하더라도 응답을 제공할 수 있어야 함**.
- 요청이 들어오면 가능한 모든 노드에서 응답을 반환해야 하며, 시스템이 다운되지 않도록 함.
- **일관성을 보장하기 어려운 대신 빠른 응답을 제공**.
- 예: **SNS, 메시징 서비스**.

### **3) 파티션 감내(Partition Tolerance)**
- 네트워크 장애(Partition)가 발생하더라도 **시스템이 동작해야 함**.
- 분산 환경에서는 네트워크 장애가 불가피하므로, **현실적으로 모든 분산 시스템은 파티션 감내를 지원해야 함**.

> **실제로 CAP 정리에 따르면, 모든 분산 시스템은 CP(일관성과 파티션 감내), AP(가용성과 파티션 감내) 중 하나를 선택해야 함.**
>
> CA(일관성과 가용성) 시스템은 네트워크 장애를 감내하지 않는 환경에서만 가능하며, 현실적으로 존재하기 어려움.

---

## **4. 단일 서버 키-값 저장소**
- **구현이 비교적 간단함**
- **단순한 해시 테이블 사용 가능하지만 메모리 한계 존재**.
- 해결책:
    - 데이터 압축(Compression)
    - 자주 사용되는 데이터만 메모리에 유지, 나머지는 디스크 저장.
- **대규모 시스템에서는 분산 키-값 저장소 필요**.

---

## **5. 분산 키-값 저장소(Distributed Key-Value Store)**
- **데이터를 여러 서버에 분산하여 저장** → 분산 해시 테이블(DHT) 활용.

---

## **6. 데이터 파티셔닝(Partitioning)**
- 데이터를 여러 서버에 분산 저장하여 **부하를 균등하게 분배**.
- **안정 해시(Consistent Hashing)** 활용:
    - **자동 확장 가능** (Auto Scaling)
    - **서버 추가/삭제 시 최소한의 데이터 이동 보장**
    - **고성능 서버에 더 많은 부하를 분배할 수 있도록 가상 노드(Virtual Nodes) 적용 가능**.

---

## **7. 데이터 복제(Replication)**
- **가용성과 안정성을 높이기 위해 데이터를 N개의 서버에 비동기적으로 복제**.
- **데이터 복제 방식**:
    - **N개의 노드를 선정하여 복제 진행** (안정 해시를 기반으로 결정).
    - **다른 데이터센터에도 복제하여 장애 대비**.

---

## **8. 데이터 일관성(Consistency)**
- **정족수 합의(Quorum Consensus) 프로토콜** 사용:
    - **N**: 데이터 복제 개수
    - **W**: 쓰기 연산이 성공하기 위한 최소 응답 개수
    - **R**: 읽기 연산이 성공하기 위한 최소 응답 개수
- **설정 예시**:
    - `R = 1, W = N`: 빠른 읽기 연산
    - `W = 1, R = N`: 빠른 쓰기 연산
    - `W + R > N`: 강한 일관성(Strong Consistency) 보장
    - `W + R ≤ N`: 결과적 일관성(Eventual Consistency)

---

## **9. 데이터 버저닝 & 충돌 해결**
- **데이터 버저닝(Versioning)**:
    - 데이터 변경 시 새로운 버전 생성.
    - 변경 불가능(Immutable)한 데이터 유지.
- **벡터 시계(Vector Clock)**:
    - 각 데이터의 버전 관리하여 충돌 감지 및 해결.
    - 충돌 발생 시 클라이언트가 직접 해결.

---

## **10. 장애 처리(Failure Handling)**
### **1) 장애 감지(Failure Detection)**
- **가십 프로토콜(Gossip Protocol)** 사용:
    - 노드 간 주기적으로 상태 공유.
    - 특정 노드의 응답이 없으면 장애로 간주.

### **2) 일시적 장애 처리(Temporary Failure Handling)**
- **느슨한 정족수(Sloppy Quorum) & 단서 후 임시 위탁(Hinted Handoff)**:
    - 장애 발생 시 임시로 다른 노드가 요청을 처리.
    - 장애가 복구되면 변경사항을 원래 노드에 전송.

### **3) 영구적 장애 처리(Permanent Failure Handling)**
- **반-엔트로피(Anti-Entropy) 프로토콜 + 머클 트리(Merkle Tree) 활용**:
    - 사본 간의 데이터 비교 및 동기화.
    - 변경된 부분만 비교하여 효율적인 데이터 동기화.

---

## **11. 데이터센터 장애 대응**
- **데이터를 여러 데이터센터에 복제하여 장애에 대비**.
- **데이터센터 간 고속 네트워크로 연결**하여 데이터 동기화.

---

## **12. 시스템 아키텍처(System Architecture)**
- **클라이언트(Client)**: `put(key, value)`, `get(key)` API 요청.
- **중재자(Coordinator)**: 클라이언트 요청을 처리하는 프록시 역할.
- **안정 해시를 기반으로 노드(Node) 분산 배치**.
- **모든 노드는 동일한 책임을 가지며 SPOF(Single Point of Failure)가 없음**.

---

## **13. 쓰기/읽기 경로**
### **쓰기 경로(Write Path)**
1. 커밋 로그(Commit Log) 작성.
2. 메모리 캐시에 데이터 저장.
3. 특정 임계치를 넘으면 디스크(SSTable)로 저장.

### **읽기 경로(Read Path)**
1. 메모리 캐시에서 데이터 검색.
2. 없으면 **블룸 필터(Bloom Filter)** 를 통해 SSTable 위치 탐색.
3. SSTable에서 데이터 조회 후 반환.

---

## **14. 요약**
| **목표 / 문제** | **해결 기술** |
|--------------|-------------|
| 대규모 데이터 저장 | 안정 해시를 사용해 서버들에 부하 분산 |
| 읽기 연산에 대한 높은 가용성 보장 | 데이터를 여러 데이터센터에 다중화 |
| 쓰기 연산에 대한 높은 가용성 보장 | 버저닝 및 벡터 시계를 사용한 충돌 해소 |
| 데이터 파티션 | 안정 해시(Consistent Hashing) |
| 점진적 규모 확장성 | 안정 해시 |
| 다양한 환경 지원 | 안정 해시 |
| 조절 가능한 데이터 일관성 | 정족수 합의(Quorum Consensus) |
| 일시적 장애 처리 | 느슨한 정족수(Sloppy Quorum) & 단서 후 임시 위탁(Hinted Handoff) |
| 영구적 장애 처리 | 머클 트리(Merkle Tree) |
| 데이터센터 장애 대응 | 여러 데이터센터에 걸친 데이터 다중화 |

---
**결론**:  
분산 키-값 저장소는 **안정 해시, 데이터 복제, 정족수 합의, 벡터 시계, 머클 트리** 등의 기술을 활용하여 **확장성과 가용성을 보장하면서도 데이터 일관성을 유지하는 시스템**을 구축한다.
