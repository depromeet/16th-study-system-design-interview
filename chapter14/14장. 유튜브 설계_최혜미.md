# 유튜브(영상 업로드) 설계 요약

유튜브 설계라 하지만, 실제로는 **비디오 업로드 및 트랜스코딩 시스템**에 초점을 맞추고 있습니다. (추천, 라이브 스트리밍 등은 다루지 않음)

---

## 1. 서론 및 고려사항

- **데이터 특성**:
    - 비디오는 기가바이트 단위로 매우 크며, 일반 텍스트나 이미지와 달리 인프라 비용과 처리 속도에 큰 영향을 줌.

- **핵심 요구사항**:
    - **빠른 비디오 업로드**: 사용자 경험 개선
    - **원활한 비디오 재생**: 다양한 해상도 지원 및 네트워크 상황에 따른 적응
    - **재생 품질 선택**: 사용자 환경에 맞춘 화질 제공
    - **인프라 비용 통제**: 대용량 데이터 처리 비용 최적화
    - **높은 가용성 및 확장성**

- **관련 개념**:
    - **CDN (Content Delivery Network)**: 사용자와 물리적으로 가까운 서버에 비디오 복사본을 보관해 빠른 스트리밍 제공
    - **비디오 인코딩/트랜스코딩**: 원본 비디오를 다양한 해상도/코덱 조합(예: 360p, 480p, 720p, 1080p, 4K)으로 변환하여 압축 처리
    - **GOP (Group of Pictures)**: 비디오 스트림을 몇 초 단위의 독립 재생 가능한 프레임 그룹으로 분할

---

## 2. 전체 설계도 개요

### 비디오 업로드 및 처리 흐름

1. **원본 저장소 → 인코딩 처리**
    - 사용자가 비디오 업로드 → 원본 저장소에 저장
    - **트랜스코딩 서버**가 원본 저장소에서 비디오를 가져와 인코딩 시작
    - 인코딩 완료 큐를 통해 비동기로 처리 (비디오 인코딩, 썸네일 추출, 워터마크 삽입 등)

2. **메타데이터 갱신 및 사용자 알림**
    - API 서버는 병렬적으로 비디오 메타데이터(파일 이름, 크기, 포맷, 해상도 등)를 업데이트
    - 업로드 완료 후 사용자에게 스트리밍 준비 완료를 알림

### 비디오 재생 흐름

- **CDN**을 통해 최종 인코딩된 비디오를 다양한 화질로 제공
- 스트리밍 프로토콜(MPEG-DASH, HLS 등)을 사용하여 클라이언트에 직접 스트리밍

---

## 3. 빠른 업로드를 위한 상세 설계

### 3.1 비디오 트랜스코딩 파이프라인 (DAG 모델 활용)

- **전처리기**
    - **비디오 검사**: 파일 손상 여부 및 품질 확인
    - **비디오 분할**: 원본 비디오를 GOP 단위로 분할
    - **DAG 생성**: 인코딩, 썸네일 추출, 워터마크 등 실행 작업 및 순서를 정의
    - **데이터 캐시**: GOP와 메타데이터를 임시 저장하여 인코딩 실패 시 재시도 지원

- **DAG 스케줄러**
    - 생성된 DAG를 여러 **작업 단계(stage)**로 분할
    - 각 단계별 작업을 **자원 관리자**의 작업 큐에 집어넣음

- **자원 관리자 & 작업 서버**
    - **작업 큐**: 우선순위에 따라 실행할 작업 보관
    - **작업 서버 큐**: 작업 서버의 가용 상태 정보 관리
    - **실행 큐**: 현재 진행 중인 작업 및 서버 정보 관리
    - **임시 저장소**: 작업 실패 시 데이터를 보관 (메타데이터는 메모리, 비디오/오디오 데이터는 BLOB 저장소)

### 3.2 비동기 처리 및 병렬 업로드

- **비동기 처리**:
    - 각 단계가 독립적으로 진행되어 앞 단계가 늦어도 전체 파이프라인이 병목 없이 작동
    - **메시지 큐**를 도입하여 각 모듈(인코딩, 업로드 등) 간 결합도 낮춤

- **병렬 업로드**:
    - 비디오를 GOP 단위로 분할하여 동시에 여러 조각을 업로드
    - 업로드 센터를 사용자 근접 지역에 배치하여 업로드 속도 향상

---

## 4. 최적화 및 보안

### 최적화 방안

- **메타데이터 활용**:
    - 비디오 제목, 태그, 설명 등으로 인덱싱하여 검색, 추천, 광고 등 다양한 기능 지원

- **여러 화질 인코딩**:
    - 네트워크 상황에 따라 자동/수동으로 화질 조절 (Adaptive Bitrate Streaming)

- **비용 최적화**:
    - 롱테일(long-tail) 분포를 활용하여 인기 비디오는 CDN, 나머지는 별도의 비디오 서버로 처리
    - 특정 지역에 한정된 비디오는 해당 지역에만 복제

### 보안 및 오류 처리

- **보안 강화**
    - **미리 사인된 업로드 URL**: 권한 있는 사용자만 올바른 위치에 업로드 가능
    - **비디오 보호**: DRM, AES 암호화, 워터마크 삽입 등으로 저작권 보호

- **오류 처리 전략**
    - **회복 가능 오류**: 인코딩 실패, 비디오 분할 오류 등은 재시도 로직 적용
    - **회복 불가능 오류**: 비디오 포맷 오류 등은 즉시 중단 후 클라이언트에 오류 코드 반환
    - **서버 장애 대응**:
        - API 서버: Stateless 설계로 다른 서버로 우회
        - 메타데이터 캐시/DB: 다중화 및 자동 복구 적용

---

## 5. 요약

- 유튜브 영상 업로드 시스템은 **비디오의 대용량**과 **다양한 인코딩 요구**에 대응하기 위해 **비동기, 병렬 처리** 및 **DAG 기반 파이프라인**을 사용합니다.
- **CDN**과 **메타데이터 관리**를 통해 빠른 재생 및 다양한 화질 제공을 보장하며, **최적화**와 **보안/오류 처리** 전략으로 높은 가용성과 안정성을 달성합니다.
- 최종 목표는 **빠른 업로드**, **원활한 스트리밍**, 그리고 **인프라 비용 효율성**을 확보하는 것입니다.
