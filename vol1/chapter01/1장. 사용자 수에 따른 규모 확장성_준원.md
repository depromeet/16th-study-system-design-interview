클라가 요청하면 DNS 서버에서 IP 주소를 받아서 HTTP 요청을 하게 됨.
요청을 받은 웹 서버는 HTML 페이지나 JSON 형태의 응답을 반환함.

RDBMS는 자료를 테이블과 열, 칼럼으로 표현해 SQL을 사용해 데이터를 관계에 따라 join해 합칠 수 있다.

비관계형 데이터베이스 NoSQL은 여러가지가 있음.
그 중에서도 Key-Value Store, Document Store, Column Family Store, Graph Database가 있음.

## 비 관계형 DB가 적합한 경우
- 아주 낮은 응답 지연시간이 요구될 때
- 다루는 데이터가 비정형이랑 관계형 데이터가 아닐 때
- 데이터(JSON, XML, yaml)를 직렬화하거나 역직렬화 할 수 있기만 하면 될 때
- 아주 많은 양의 데이터를 저장할 필요가 있을 때

### Q) 로그 같은 것들을 저장할 때 로그 파일을 관리하는 것과 NoSQL로 저장하는 것에서 각각의 장단점은?
- 파일 관리
  - 파일로 관리하기 때문에 수정에 자유롭지가 않다.
  - 여러 클라이언트가 접근할 때 문제가 생길 수 있다.
    - 데이터 정합성 등
- NoSQL
  - 속도가 매우 빠르다
  - 여러 클라이언트가 접근에 문제가 없다.
  - 파일 관리에 비해서 CRUD에서 자유롭다
  - 키바나 등을 사용할 수 있어서 시각화 하는 데 유리하다.
  - 중앙 집중화하기 편리해진다.
    - 다양한 도메인과 서버에서 오는 로그들을 관리하고 체크하기 편리해진다.

### 스케일 업 : 수직적 확장
- 고사양 자원을 추가(더 좋은 CPU, 더 좋은 RAM 등)

### 스케일 아웃 : 수평적 확장
- 서버를 추가해 성능 개선

스케일 업은 단순해서 엄청 큰 장점임
단점
- 한 대의 서버에 CPU나 메모리를 무한대로 증설할 방법 X
- 장애에 대한 자동 복구 방안이나 다중화 방안을 제시하지 않음.
- 서버 장애 시 웹 사이트/앱이 완전 중단됨

## 로드밸런서
직접 서버로 들어가는 것이 아니라 로드밸런서 주소를 사용하고, 로드밸런서가 서버에 접근한다.
이때 보안을 위해 서버 통신에서는 private 주소를 사용할 수 있다.

## DB 다중화
- Master-Slave 구조


### Q) Slave 서버에 최신화 되기 전 읽을 수 있지 않나?
- 클러스터링 (active-stanby or active-active)
    - 여러 DB를 수평적 구조로 구성해 시스템을 구축
    - 동기 방식으로 노드들 간의 데이터를 동기화
    - 동기화 시간으로 인해 리플리케이션에 비해 쓰기 성능이 낮음
- 리플리케이션 (master-slave)
    - master
        - DML(INSERT, UPDATE, DELETE) 쿼리를 처리
        - Write-only
    - slave
        - Read-only
    - 비동기 방식으로 노드들 간의 데이터를 동기화
    - 지연 시간이 거의 없음
    - 데이터 동기화가 보장되지 않아 일관성 있는 데이터를 얻지 못할 수 있음
    - 데이터 양이 많으면 찾는 데 오래 걸림
    - 마스터 노드 장애 시 복구&대처가 까다로움
- 복제 지연의 원인과 해결
    - 장기 실행 쿼리
        - SBR(Statement Based Replication, SQL을 전송해 복제하는 방식)
            - 복제본에서 replay 되는 시간으로 인해 지연시간이 2배가 된다
        - 해결 방법
            - RBR(Row Based Replication, 변경된 결과를 복제하는 방식)
            - MBR(Mixed Based Replication, 비결정적 동작(Unsafed Statement)의 경우에만 RBR로 동작)
    - 쓰기 쿼리량 증가
        - 해결 방법
            - Multi-Threaded Replication 설정을 통해 복제를 적용하는 worker 스레드 개수를 늘려 처리 속도 향상 가능
            - 샤딩이나 도메인 자체를 분리해 경량화하는 것도 도움이 됨
    - slave의 로드 증가
        - 읽기 트래픽 증가로 인한 복제 지연
        - 해결 방법
            - 복제본을 추가해 해결
- Semi-Sync Replication + MHA(Master High Availability)
    - 반동기 복제 방식
    - MHA(Master High Availability)를 통해 마스터 노드 장애 시 대처 가능

DB slave 서버가 master를 대체하기엔 최신 상태가 아닐 수 있음.
이때 없는 데이터는 복구 스크립트를 돌려서 추가해야함.
다중 마스터나 원형 다중화 방식을 도입하면 해결 가능하지만, 훨씬 복잡해진다.

## 응답 시간 개선
캐시를 붙이고 정적 파일을 CDN에 올려서 응답 시간을 개선할 수 있다.
Content Delivery Network(CDN)은 전 세계에 분산된 서버에 캐시를 저장해 두고, 사용자가 요청하면 가장 가까운 서버에서 응답을 받을 수 있게 해준다.

캐시는 비용이 높은 연산 결과나 자주 참조되는 데이터를 메모리 안에 두고 빠르게 처리될 수 있게 하는 저장소다.
요청을 받으면 우선 캐시에 있는지 확인함. 없을 경우 DB에서 읽어서 캐시에 저장한 뒤 반환함.
-> 읽기 주도형 캐시 전략

캐시는 데이터 갱신이 자주 일어나지 않으며 참조는 빈번한 경우에 고려해볼 만 하다.
영속적으로 저장해야할 데이터를 캐시에 두는 것도 바람직하지 않다.
캐시에 보관된 데이터에 대한 만료 정책도 마련해둬야 한다.
저장소의 원본을 갱신하는 연산과 캐시를 갱신하는 연산이 단일 트랜잭션으로 처리되지 않는 경우 일관성이 깨질 수 있다.

CDN을 통해서 정적 파일을 제공하면 응답 시간을 개선할 수 있다.
CDN은 전 세계에 분산된 서버에 캐시를 저장해 두고, 사용자가 요청하면 가장 가까운 서버에서 응답을 받을 수 있게 해준다.
클라는 CDN에 정적 파일을 요청하게 되고, CDN에 없을 경우 서버에서 CDN에 저장한 후 반환한다.
비용과 적절한 만료 시한 설정, CDN 장애, 컨텐츠 무효화에 대한 대처 방안 등을 고민해봐야 한다.

## Stateless 웹 계층
수평적으로 확장할 경우 사용자 세션 데이터와 같은 상태 정보를 웹 계층에서 제거해야한다.
상태 정보를 RDMS나 NoSQL에 저장하고, 필요할 때만 가져오도록 해야한다. -> 무상태 웹 계층
-> 상태 정보에 의존적이게 돼서 기존 연결을 받던 서버에 종속됨.
-> 로드 밸런서로 고정 세션이라는 기능을 사용해서 설정할 수 있지만,

## 다중 데이터센터 아키텍처
- 트래픽 우회 : 올바른 데이터 센터로 트래픽을 보내는 효과적인 방법을 찾아야함. GeoDNS는 사용자에게서 가장 가까운 데이터 센터로 트래픽을 보내야함.
- 데이터 동기화 : 데이터 센터 간의 데이터가 동기화 되어야 함. 장애가 자동으로 복구되어 트래픽이 다른 DB로 우회되어도 데이터가 존재해야 함.
- 테스트와 배포 : 여러 위치에서 시스템이 구성됐을 때엔 웹 사이트 또는 애플리케이션을 여러 위치에서 정상 동작하는지 확인해야함. 자동화된 배포 도구로 모든 데이터 센터에 동일하게 서비스가 설치되도록 해야함.

## 메시지 큐
메시지 무손실을 보장하는 비동기 통신을 지원하는 컴포넌트. 메시지의 버퍼 역할을 하며, 비동기적으로 전송함.
메시지 큐는 생산자나 발생자라고 불리는 입력 서비스가 메시지를 만들어 메시지 큐에 발행하고, 소비자나 구독자라 불리는 서비스나 서버가 메시지를 받아서 그에 맞는 동작을 수행한다.

## 로그, 메트릭 그리고 자동화
- 로그 :  에러 로그를 모니터링하는 것은 중요한데, 단일 서비스로 모아주면 더욱 활용하기 편리할 것임.
- 메트릭 : 메트릭을 통해 사업 현황에 대한 유용한 정보를 얻거나, 시스템의 현제 상태를 쉽게 파악할 수 있음.
    - 호스트 단위 메트릭 : CPU, 메모리, 디스크 I/O
    - 종합 메트릭 : DB 계층의 성능, 캐시 계층의 성능 등
    - 핵심 비즈니스 메트릭 : 일별 능동 사용자, 수익, 재방문 등
- 자동화 : CI/CD와 같은 도구를 사용하면 문제를 쉽게 감지할 수 있음.
    - e.g) CI 과정에서 테스트를 거치게 하여 문제를 발견할 수 있게 함.

## DB의 규모 확장
- 수직적 확장
    - CPU나 RAM 등의 성능을 높임.
    - 단일 서버의 한계에 도달하면 수평적 확장을 고려해야 함.
    - SPOF(Single Point of Failure)가 발생할 수 있음.
- 수평적 확장, 샤딩
    - 샤드는 같은 스키마를 사용하지만, 데이터의 중복은 없다.
    - 샤딩 시에는 샤딩 키(파티션 키)를 어떻게 정하는지가 중요하다.
- 샤딩 도입 시 풀어야할 문제
    - 데이터 재샤딩
        - 샤드 하나로 감당이 어려울 때
        - 특정 샤드에 할당된 공간 소모가 다른 샤드에 비해 빠를 때
    - 유명인사(celebrity) 문제(핫스팟 키)
        - 특정 샤드에 질의가 집중되어 서버에 과부하가 걸리는 문제
    - 조인과 비정규화
        - 여러 샤드에 걸친 데이터를 조인하기 힘들어짐
            - 비정규화를 해 하나의 테이블에서 질의가 수행되도록하는 해결방법 등이 있다

- 웹 계층은 무상태 계층으로
- 모든 계층에 다중화 도입
- 가능한 많은 데이터를 캐시
- 여러 데이터 센터 지원
- 정적 콘텐츠는 CDN을 통해 서비스
- 데이터 계층은 샤딩을 이용
- 각 계층은 독립적 서비스로 분할
- 시스템은 지속적으로 모니터링하고, 자동화 도구를 활용

Q) 단일 서버를 사용할 정도의 서비스라면 데이터 정합성이 발생하지 않을 것이라고 생각했음. 발생할 수 있는 데이터 정합성 문제가 있는가?
- 현재는 기억이 나지 않음.
  - 다만, 이러한 질문을 면접에서 받는 다고 하면 100% 데이터 정합성 문제가 발생하지 않는 다고 보장할 수 있는지 먼저 재질의할 것 같음.
  - 이후 데이터 정합성과 같은 문제점이 발생할 수 있다고 가정 후 좋은 해결 방법을 찾아볼 것 같음.
  - 문제가 발생하더라도 바로 해결할 수 있도록 


Q) 로드 밸런서 적용 시 확장성, 가용성, 안정성 부분에서 부족한 부분은 무엇일까?