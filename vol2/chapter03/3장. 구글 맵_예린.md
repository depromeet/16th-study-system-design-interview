# 3장. 구글 맵
## 목표
구글 맵을 설계하라.
- 웹 기반 지도 서비스
- 위성 이미지, 거리 뷰, 실시간 교통 상황, 경로 계획 등 다양한 서비스 제공
- 2021년 3월 기준 DAU 10억명
- 전세계 99% 지역의 지도를 제공
- 정확한 실시간 위치 정보를 위해 매일 2500만 건의 업데이트 반영
## 1단계. 문제 이해 및 설계 범위 확정
- DAU 10억명
- 핵심 기능: 위치 갱신, 경로 안내, ETA, 지도 표시 등
- 도로 데이터 규모: 수 TB 수준의 가공되지 않은 데이터
- 교통 상황: 도착 시간을 최대한 정확하게 추정하기 위해 고려
- 이동 수단: 다양한 이동 방법 지원
- 다중 경유지 설정: 고려 X
- 사업장 위치 및 사진 표시: 고려 X
### 기능 요구사항
- 사용자 위치 갱신
- 경로 안내 서비스 (ETA 서비스 포함)
- 지도 표시
### 비기능 요구사항 및 제약사항
- 정확도: 정확한 경로 안내
- 부드러운 경로 표시: 클라이언트를 통해 제공되는 경로 안내 용도의 지도는 부드럽게 갱신
- 데이터 및 배터리 사용량: 최소한으로 사용, 모바일 단말에서 중요한 요구사항
- 가용성, 규모 확장성
### 지도 101
#### 측위 시스템
- 구 표면 상의 위치를 표현하는 체계
#### 3차원 위치의 2차원 변환
- 지도 투영법(도법): 3차원 구의 위치를 2차원 평면에 대응시키는 절차
- 구글 맵: 메르카토르 도법을 조금 변경한 **웹 메르카토르 도법** 사용
#### 지오코딩
- 주소를 지리적 측위 시스템의 좌표로 변환하는 프로세스
- 역 지오코딩: 지오코딩 결과 -> 주소
- 인터폴레이션: GIS 같은 다양한 시스템이 제공하는 데이터를 결합
  - GIS: 도로망을 지리적 좌표 공간에 대응시키는 방법 제공
#### 지오해싱
- 지도 위 특정 영역을 영문자와 숫자로 구성된 짧은 문자열에 대응시키는 인코딩 체계
- 사용 용도: 맵 타일 관리
#### 지도 표시
- 타일: 지도를 화면에 표시하는 기본 단위
- 확대/축소 지원 시 확대 수준에 따라 다른 종류의 타일 준비
### 경로 안내 알고리즘을 위한 도로 데이터 처리
- 경로 탐색 알고리즘: 다익스트라 or A* 경로 탐색 알고리즘의 변종
- 그래프 자료 구조를 가정: 교차로 == 노드, 도로 == 간선
- 성능 <-> 그래프 크기: 크기에 따라 메모리량, 경로 탐색 성능 결정
- 작은 격자(경로 안내 타일)로 분할하여 격자 내 도로망을 그래프 자료 구조로 변환하고, 각 타일은 도로로 연결된 다른 타일에 대한 참조 유지
  - 느끼기에 약간 SCC?
  - 메모리 요규량 감소
  - 한 번에 처리할 경로양 감소
  - 성능 향상
#### 계층적 경로 안내 타일
- 필요 수준의 구체성을 갖춘 도로 데이터 필요
- 구체성 상/중/하로 구분하여 3가지 종류의 경로 안내 타일 준비
  - 상: 타일 매우 작음, 지방도 데이터만 배치
  - 중: 비교적 규모가 큰 관할구를 잇는 간선 도로 데이터 배치
  - 하: 도시와 주를 연결하는 주요 고속 도로 데이터 배치
### 개략적 규모 추정
- 타겟: 모바일 단말
#### 저장소 사용량
- 저장할 데이터
  - 세계 지도
  - 메타데이터: 각 지도 타일의 메타데이터 (매우 작아서 추정에서 고려 X)
  - 도로 정보: 외부에서 받은 수TB 용량의 도로 데이터 보유 -> 경로 안내 타일로 변환 (용량은 비슷)\
- 세계 지도
  - 확대 수준 별 지도 타일 한 벌씩 보유
  - 최대 확대 수준 대상으로 약 4.4조 개 타일 필요
  - 4.4조 * 100KB = 440PB
  - 그 중 90%는 사람이 살지 않는 자연이므로 압축하여 저장 용량 절약 (440PB -> 88PB) : 50PB로 가정
  - 각 수준 별 필요 타일 수 = 1/4배
  - 총 대략 67PB 정도 필요 (100PB로 가정)
- 서버 대여폭
  - 경로 안내 요청
    - DAU 10억
    - 기능 사용 시간 주당 35분
    - 주당 350억 분 / 7일 = 하루 50억 분
    - 매초 GPS 좌표 전송 = 50억 분 * 60 = 3000억
    - QPS = 3000억 건 / 10^5 = 300만
    - 15초에 한 번씩 서버에 변경 내역 모아 전송 시 QPS = 20만
    - 최대 QPS = 20만 * 5 = 100만
## 2단계. 개략적 설계안 제시 및 동의 구하기

<img alt="image" src="https://github.com/user-attachments/assets/7214f070-f296-4d65-95d8-5a129f2a4e00">

#### 데이터 사용량
- 사용자 이동 속도: 30km/h
- 지도 화면 배율: 200m * 200m
- 1km*1km 영역 표현 위해 필요한 이미지: 25장 = 25MB
- 데이터 소진량 = 30 * 2.5MB / 60분 = 분당 1.25MB
#### CDN으로 서비스 트래픽 규모
- 매일 50억 분 가량의 경로 안내 처리
- 50억 * 1.25MB = 6.25PB/일
- 초당 전송할 지도 데이터 양 = 62500MB
- 전세계에 200개의 POP가 있다면, 각 POP는 수백 MB 트래픽 처리
  - 지리적으로 가까운 곳에서 트래픽을 처리
  - 서버로의 네트워크 비용 절약
#### 클라이언트가 CDN에서 지도 타일을 가져올 URL 결정하는 방법
1.지오해시 사용
  - 클라이언트에서 연산 수행
  - 대신, 클라이언트에서 해당 알고리즘을 구현해 놓았을 때 지원해야 할 플랫폼이 많다면 이후에도 계속 맵 타일 인코딩에는 지오해싱을 사용한다는 보장 필요 (교체 비용 부담)
2.주어진 위도/경도 및 확대 수준을 타일 URL로 변환하는 알고리즘을 구현을 별도 서비스에 두기
  - 위도, 경도, 현재 확대 수준 입력으로 타일 URL 연산
  - 운영 유연성 향상
  - 동작 방식
    1. 모바일 사용자가 타일 URL들을 가져오기 위해 지도 타일 서비스를 호출
    2. 로드 밸런서는 해당 요청을 지도 타일 서비스로 전달
    3. 지도 타일 서비스는 클라이언트의 위치와 확대 수준을 입력으로 삼아 9개의 타일 URL을 계산하여 클라이언트에 반환
    4. 모바일 클라이언트는 해당 타일을 CDN을 통해 다운로드
## 3단계. 상세 설계
### 데이터 모델
#### 1. 경로 안내 타일
- 방대한 양의 도로 및 메타데이터로 구성
- 그래프 자료 구조 형태로 가공되지 않은 데이터: 주어진 상태 그대로는 입력으로 사용 불가
- 경로 안내 타일 처리 서비스(오프라인 데이터 가공 파이프라인)을 주기적으로 실행하여 경로 안내 타일로 변환
- 그래프 데이터는 주로 메모리에 인접 리스트 형태로 보관하지만, 너무 많은 데이터 양이므로 S3와 같은 객체 저장소 활용
  - 지오해시 기준으로 분류해 두어 위도/경도로 타일을 신속하게 탐색
#### 2. 사용자 위치
- 사용자 위치 정보 활용 방향
  - 도로 데이터 및 경로 안내 타일 갱신
  - 실시간 교통 상황 데이터나 교통 상황 이력 데이터베이스를 구축하는 데 활용
  - 데이터 스트림 프로세싱 서비스는 이 위치 데이터를 처리하여 지도 데이터 갱신
- 엄청난 양의 쓰기 연산 처리 필요
  - 수평적 규모 확장 가능한 데이터베이스 필요
  - 카산드라
#### 3. 지오코딩 데이터
- 주소를 위도/경도 쌍으로 변환하는 정보를 보관
- 레디스
  - 읽기 연산은 빈번하지만, 쓰기 연산은 드물게 발생
  - 빠른 읽기 연산 제공
#### 4. 미리 계산해 둔 지도 타일 데이터
- 이미지는 한 번만 계산하고 결과를 캐시해 두는 전략 사용 -> CDN
- CDN 원본 서버 -> S3 같은 클라우드 저장소
### 서비스
#### 위치 서비스
- 초당 백만 건의 위치 정보 업데이트 발생 -> 쓰기 연산 지원에 탁월한 데이터베이스 필요
- NoSQL 키-값 데이터베이스나 열-중심 데이터베이스가 적합
  - key: (user_id, timestamp)
    - user_id: 파티션 키 (특정 사용자의 최근 위치를 빠르게 조회하기 위함)
    - timestamp: 클러스터링 키
    - 같은 파티션 키를 가지는 데이터는 함께 저장되는 클러스터링 키 값에 따라 정렬
- 사용자 위치는 계속 변화하며 변경 후에는 이전 정보 무용 -> 일관성 <<< 가용성
- **가용성 & 분할 내성** 만족에 집중
#### 사용자 위치 데이터는 어떻게 이용되는가?
- 사용자 위치는 쓰임새가 다양 -> **별도의 카프카와 같은 메시지 큐에 로깅**
- 카프카
  - 응답 지연 낮음
  - 많은 데이터 동시 처리
  - 실시간 데이터 피드 지원 위해 고안
- 개별 서비스는 카프카를 통해 전달되는 사용자 위치 데이터 스트림을 각자 용도에 맞게 활용

<img alt="image" src="https://github.com/user-attachments/assets/8985522e-beee-4407-b4bf-ffb5a46434da">

### 지도 표시
#### 지도 타일 사전 계산
- 확대 수준 +1 마다 전체 타일 수는 동서 방향 2배, 남북 방향 2배 증가
  - 해당 수준 전부를 합친 해상도는 그 이전 수준 대비 4배 증가
- 화면에 한 번에 표시 가능한 지도 타일 개수는 변하지 않음
#### 최적화: 벡터 사용
- 이미지 대신 경로, 다각형, 벡터 정보 전송
- 클라이언트는 수신된 경로와 다각형 정보를 통해 지도 그림
- 장점
  - 월등한 압축률
  - 네트워크 대여폭 절약
  - 매끄러운 지도 확대 경험
### 경로 안내 서비스

<img alt="image" src="https://github.com/user-attachments/assets/63de9fdd-a6c4-43a4-948f-f2b699327ac2">

#### 중요 정보 갱신 서비스들
- 카프카 위치 데이터 스트림을 구독하고 있다가 비동기적으로 업데이트
- 실시간 교통 정보 데이터베이스, 경로 안내 타일 등
#### 적응형 ETA와 경로 변경
- 현재는 고려 X
- 서버는 현재 경로 안내를 받고 있는 모든 사용자를 추적하면서 교통 상황이 달라질 때마다 각 사용자의 ETA를 변경
- 현재 경로 안내를 받고 있는 사용자는 어떻게 추적하는가?
- 수백만 경로 가운데 교통 상황 변화에 영향 받는 경로와 사용자를 효율적으로 가려낼 방법은?
1. 레코드 전수 조사
   - 레코드 수 = n, 경로 평균 길이 = m -> O(n*m) 시간 복잡도
2. 상위 타일 간 재귀적으로 보관
   - 어떤 타일의 교통 상황이 변했을 때 경로 안내 ETA가 달라지는 사용자는 해당 사용자의 DB 레코드 마지막 타일에 속한 사용자
   - O(n) 시간 복잡도
   - 경로 재설정 가능함을 감지하고, 알리는 데에는 여전히 한계 있음
     - 방안: 현 경로 안내 받는 사용자가 이용 가능한 경로의 ETA를 주기적으로 재계산하여 더 짧은 ETA 갖는 경로 발견 시 알림
#### 전송 프로토콜
- 데이터 변경 이력을 모바일 클라이언트에게 전송할 방법
- 모바일 푸시 알림, 롱 폴링, 웹 소켓, 서버 전송 이벤트 등
  - 모바일 푸시 알람: 보낼 수 있는 메시지 크기가 매우 제한적, 웹 애프리케이션 미지원
  - 웹소켓: 서버 부담 작음, 롱 폴링보다 나은 선택지, 양방향 통신 지원
## 4단계. 마무리
### 추가 고려사항
- 기업 고객 대상으로 중간 경유지 설정 기능
  - 도어대시, 우버, 리프트 같은 배달 서비스에 유용