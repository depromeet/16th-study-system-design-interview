# 근접성 서비스 설계 

## 1. 문제 이해 및 설계 범위 확정

### 기능 요구사항
- **사업장 목록 반환:**  
  사용자의 위도/경도와 검색 반경 정보를 기반으로 해당 범위 내 사업장 목록 반환
- **사업장 정보 관리:**  
  사업장 소유주가 사업장 정보를 추가/삭제/갱신할 수 있음 (변경 사항은 다음날 자정에 반영)
- **상세 정보 조회:**  
  고객은 사업장에 대한 상세 정보를 확인할 수 있음

### 비기능 요구사항
- **낮은 응답 지연(Latency):**  
  사용자가 빠르게 주변 사업장을 검색할 수 있도록 함
- **데이터 보호(Data Privacy):**  
  사용자 위치와 같은 민감 정보 보호 (GDPR, HIPAA, CCPA 등 준수)
- **고가용성 및 확장성:**  
  인구 밀집 지역 등 트래픽 급증 상황에서도 안정적 서비스 제공

### 설계 범위 및 추가 고려사항
- **검색 반경:**  
  사용자가 UI에서 [0.5km, 1km, 2km, 5km, 20km] 등으로 선택 가능  
  최대 허용 반경은 20km
- **사용자 이동 속도:**  
  사용자가 빠르게 이동하지 않는다고 가정하여 상시 페이지 갱신이 필요 없음
- **검색 결과 부족 시:**  
  주어진 반경 내 사업장이 부족하면 반경 확장을 고려하는 방안 (예: 지오해시 마지막 비트 삭제)

### 개략적 규모 추정
- **DAU (일일 활성 사용자):** 약 1억 명
- **등록된 사업장 수:** 약 2억 개
- **QPS (초당 쿼리 수):** 약 5000 (사용자 1명이 하루 5회 검색 시)

---

## 2. 개략적 설계안 및 시스템 구성 요소

### 주요 컴포넌트
- **로드 밸런서 (Load Balancer):**  
  URL 경로 분석 후 트래픽을 적절한 서비스(LBS, 사업장 서비스 등)로 분배
- **LBS (Location-Based Service):**
    - 사용자 위치와 검색 반경 정보를 받아 주변 사업장을 검색
    - 읽기 요청이 매우 빈번하며, 무상태(stateless)로 수평적 확장 용이
- **사업장 서비스:**
    - 사업장 정보의 CRUD (생성/갱신/삭제)를 담당
    - 특정 시간대에 읽기 요청이 집중될 수 있음
- **데이터베이스 클러스터:**
    - **Primary DB:** 쓰기 요청 처리
    - **Secondary DB:** 읽기 요청 처리 (Replica Lag 발생 가능하지만 실시간 반영이 필요 없으므로 큰 문제 아님)

### 서비스 확장성
- **무상태 서비스:**  
  LBS와 사업장 서비스 모두 무상태이므로, 특정 시간대 트래픽 증가 시 자동으로 서버를 추가(스케일 아웃)하거나 줄일 수 있음
- **클라우드 배포:**  
  여러 지역과 가용성 구역에 배포하여 네트워크 지연 최소화 및 고가용성 확보

---

## 3. 주변 사업장 검색 알고리즘 및 지리 정보 색인

### 검색 알고리즘 비교
- **2차원 검색:**
    - 단순 구현: 위도, 경도 범위를 기준으로 검색
    - 단점: 전체 테이블 스캔 가능성이 있어 비효율적

- **균등 격자 (Uniform Grid):**
    - 지도를 균등한 격자로 분할하여 관리
    - 단점: 전 세계적으로 고른 분포가 아니므로 인구 밀집 지역에서 비효율

- **지오해시 (Geohash):**
    - 위도/경도 데이터를 문자열로 인코딩하여 범위 검색에 효율적
    - 인접 지역이 유사한 문자열을 가지므로 빠른 인접 검색 가능
    - 구현이 간단하여 많이 활용됨

- **쿼드트리 (Quadtree):**
    - 2차원 공간을 재귀적으로 4분할하여 트리 구조로 관리
    - 인구 밀집도에 따라 격자 크기를 동적으로 조정 가능
    - 단점: 구현이 복잡하고 동시성 제어(락 등) 필요

- **구글 S2:**
    - 지구를 3차원 구체로 보고 셀로 분할하여 표현
    - 높은 정밀도와 유연한 셀 크기 제공

### 인덱스 설계 방법
- **방안 1: JSON 배열로 저장**
    - **장점:** 한 번의 읽기로 해당 지오해시에 연결된 모든 사업장 ID 조회
    - **단점:** 갱신 시 전체 JSON 배열 수정 필요, 병렬 갱신 시 락(lock) 사용 필요

- **방안 2: 별도 열로 저장 (추천)**
    - **구조:** geohash와 business_id를 별도 컬럼으로 저장, 복합키 활용
    - **장점:** 개별 데이터에 대해 효율적인 추가/삭제/갱신 가능, 락 필요 없음
    - **단점:** 특정 지오해시 내 모든 사업장 조회 시 다수의 읽기 연산 필요

---

## 4. 데이터베이스 확장 및 부하 분산

### 확장 전략
- **사본 DB 서버 증설:**
    - 읽기 전용 복제본을 늘려 부하 분산
    - 개발 및 관리가 비교적 용이하나, 데이터 일관성 유지에 주의
- **샤딩(Sharding):**
    - 데이터베이스를 여러 샤드로 분할하여 읽기/쓰기 부하 분산
    - 구현과 관리가 복잡하지만 대규모 트래픽 처리에 효과적

### 캐시 전략
- **Redis 캐시 활용:**
    - 지오해시별 사업장 ID 목록을 캐시하여 조회 성능 향상
    - 사업장 상세 정보도 Redis에 캐싱하여 빠른 응답 제공
    - 캐시 키는 지오해시(또는 그 변환값)와 사업장 ID를 기반으로 함
    - 갱신 시 DB 변경 후 캐시 무효화 또는 배치 작업을 통한 일괄 갱신

### 지역 및 가용성 구역 분산
- **지역 분산의 장점:**
    - 사용자와 가까운 데이터 센터에서 처리하여 네트워크 지연 최소화
    - 국가별 데이터 전송 규제 준수를 고려하여 운영 가능
    - 인구 밀집 지역은 별도 또는 여러 가용성 구역을 활용해 부하 분산

---

## 5. 최종 동작 흐름 
1. **클라이언트 요청:**  
   사용자의 현재 위치(위도, 경도)와 검색 반경(500m)을 로드 밸런서에 전송
2. **로드 밸런서:**  
   URL 경로를 분석하여 요청을 LBS로 전달
3. **LBS 처리:**
    - 사용자 위치와 반경 정보로 적절한 지오해시 정밀도(예: 정밀도 6) 계산
    - 현재 지오해시와 인접 지오해시(보통 8방향)를 목록에 추가
    - 각 지오해시에 대응하는 사업장 ID를 Redis에서 병렬 조회
4. **사업장 정보 조회 및 후처리:**
    - 조회된 사업장 ID로 상세 정보를 Redis(또는 DB)에서 가져옴
    - 사용자와의 실제 거리를 계산, 필터링 및 정렬 후 최종 결과 반환

---


