## 10장 알림 시스템 설계

### 개요
- 고객에게 중요한 정보를 비동기 적으로 제공하는 중요한 기능
- 모바일 푸시 알림, SMS 메시지, 이메일 세가지로 분류할 수 있음

### 문제 이해 및 설계 범위 확정
- 어떤 종류의 알림을 지원해야 하는가
- 실시간 시스템인가
- 어떤 단말을 지원해야 하는지
- 알림은 누가 만들 수 있는지
- 알림을 받지 않도록 설정해야 하는가
- 하루에 몇 건의 알림을 보낼 수 있어야 하는지

### 개략적 설계안 제시 및 동의 구하기
- 알림 유형별 지원 방안
- 연락처 정보 수집 절차
- 알림 전송 및 수신 절차

### 알림 유형별 지원 방안
- ios 푸시 알림
  - 알림 제공자(provider): 알림 요청을 만들어 APNS로 보내는 주체. 단말 토큰, 페이로드가 필요
  - APNS: 애플이 제공하는 원격 서비스. 푸시 알림을 ios 장치로 보냄
  - ios 단말
- 안드로이드 푸시 알림
  - APNS 대신 FCM을 사용한다는 점만 다르다
- SMS 메시지
  - 보통 트윌리오, 넥스모 같은 제 3 사업자의 서비스를 많이 이용함
- 이메일
  - 많은 회사가 상용 이메일 서비스를 이용함
  - 센드그리드, 메일침프가 있다
  - 전송 성공률도 높고 데이터 분석도 제공함

### 연락처 정보 수집 절차
- 어떤 경우에 한 사용자가 여러 단말을 가질 수 있고, 알림은 모든 단말에 전송되어야 하는 점을 고려하자

### 알림 전송 및 수신 절차
- 알림 서버를 1대만 사용할 경우
  - SPOF 발생 가능 지점이 된다
  - DB나 캐시 등 주요 컴포넌트의 규모를 개별적으로 늘릴 수 없다
  - 트래픽이 몰리면 과부하에 빠진다
- 개선된 버전
  - DB와 캐시를 알림 시스템의 주 서버에서 분리한다
  - 수평적 규모 확장이 이뤄질 수 있도록 한다
  - 메시지 큐를 이용해 시스템 컴포넌트 사이의 강한 결합을 끊는다

### 안전성
- 데이터 손실 방지: 알림이 지연되거나 순사가 틀려도 괜찮지만, 사라지면 안된다
  - 알림 로그 데이터베이스를 유지하는 것이 한가지 방법
- 알림 중복 전송 방지: 분산 시스템 특성상 같은 알림이 중복 전송 될 수도 있음
  - 이벤트 ID를 검사하여 중복된 이벤트인지 탐지하는 로직을 도입

### 추가로 필요한 컴포넌트
- 알림 템플릿: 파라미터나 추적 링크를 조정하기만 하면 지정한 형식에 맞춰 알람을 만들어 내는 틀. 
  - 형식을 일관성 있게 유지, 알림 작성에 드는 시간 줄임
- 알림 설정: 알림 채널, 알림 받을 것인지 여부 체크해서 사용자가 피곤함을 느끼지 않게 하자
- 전송률 제한: 한 사용자가 알림을 받을 수 있는 개수를 제한해서, 너무 많은 알림을 보내지 않도록 하자
- 재시도 방법: 실패하면 재시도 전용 큐에 넣고, 계속 실패하면 개발자에게 통지
- 푸시 알림과 보안: ios 안드로이드는 appKey와 appSecret을 사용해서 보안을 유지한다
- 큐 모니터링: 큐에 쌓인 알림의 개수가 크다면 서버를 증설하자.
- 이벤트 추적: 알림 확인율, 클릭율 등의 비율은 사용자를 이해하는데 중요하다. 데이터 분석 서비스와 통합을 고려하자

