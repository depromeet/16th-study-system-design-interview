# 8장. 분산 이메일 서비스

## 목표

대규모 이메일 서비스를 설계하라.

## 1단계. 문제 이해 및 설계 범위 확정

- 사용자 수: 10억 명
- 기능: (인증 제외), 이메일 발송/수신, 모든 이메일 가져오기, 읽음 여부에 따른 이메일 필터링, 제목, 발신인, 메일 내용에 따른 검색 기능, 스팸 및 바이러스 방지 기능
- 메일 서버 연결 방법: HTTP
    - 전통적으로는 SMTP, POP, IMAP 등의 프로토콜과 서비스 제공자 전용 프로토콜을 사용해 접속
- 첨부 파일 지원 여부: 지원

### 비기능 요구사항

- 안정성: 데이터 소실 X
- 가용성: 부분 장애에도 시스템은 계속 동작, 여러 노드에 복제
- 확장성: 사용자 수 증가에 대응, 성능 저하 X
- 유연성과 확장성: 새 컴포넌트를 추가/삭제하는 것이 쉬워야 함

### 개략적인 규모 추정

- 10억명의 사용자
- 한 사람이 하루 평균 10건의 이메일 전송 -> QPS = 10^9 * 10 / 10^5 = 100,000
- 한 사람이 하루 평균 수신하는 이메일 수는 평균 40건, 이메일 당 첨부파일 외 메타데이터는 평균 60KB
- 메타 데이터는 DB에 저장한다고 가정 시 1년 간 메타데이터 유지 위한 스토리지 요구사항 = 10억 명 * 하루 40건 * 365일 * 50KB = 730PB
- 첨부 파일을 포함하는 이메일의 비율은 20%, 첨부 파일의 평균 크기는 500KB
- 1년 간 첨부 파일을 보관하는 데 필요한 저장 용량 = 10억 명 * 하루 40건 * 365일 * 20% * 500KB = 1460PB
    - 분산 데이터베이스 솔루션 필요

## 2단계. 개략적 설계안 제시 및 동의 구하기

- 이메일 101
- 전통적 메일 서버
- 분산 메일 서버

### 이메일 101

#### 이메일 프로토콜

- SMTP: SMTP는 Simple Mail Transfer Protocol
    - 이메일을 한 서버에서 다른 서버로 **보내는** 표준 프로토콜
- 이메일을 **가져오는** 목적으로 가장 널리 사용되는 프로토콜 = POP, IMAP
- POP
    - 이메일 클라이언트가 원격 메일 서버에서 이메일을 수신하고 다운로드하기 위해 사용하는 표준 프로토콜
    - 일단 단말로 다운로드 된 이메일은 서버에서 삭제
    - 결과적으로 한 대 단말에서만 이메일을 읽을 수 있음
    - 이메일 일부만 읽기 불가능
    - 용량이 큰 첨부파일 붙은 이메일 읽으려면 오래 걸림
    - RFC 1939 참고
- IMAP
    - 이메일 클라이언트가 원격 메일 서버엣 이메일을 수신하는데 사용되는 다른 표준 프로토콜
    - 클릭하지 않으면 메시지는 다운로드되지 않음, 메일 서버에서 지워지지 않음
    - 여러 단말에서 읽을 수 있음
    - 개인 이메일 계정에서 가장 널리 사용되는 프로토콜
    - 이메일 열기 전에는 헤더만 다운로드하므로 빠름
- HTTPS
    - 메일 전송 프로토콜은 아니지만, 웹 기반 이메일 시스템의 메일함 접속에 활용 가능

#### DNS

- DNS 서버는 수신자 도메인의 메일 교환기 레코드(MX)에 이용
- 송신자 측 메일 서버는 우선순위가 높은 메일서버부터 순차적으로 연결 시도하면서 메시지 보내려고 할 것

#### 첨부파일

- 이메일 메시지와 함께 전송되며 일반적으로 Base64 인코딩 사용
- 일반적으로 첨부파일에는 크기 제한 존재

#### 전통적 메일 서버

- 전통적 메일 서버 아키텍처 프로세스
    1. A 사용자는 아웃룩 클라이언트에 로그인하여 이메일을 작성하고 '보내기' 버튼을 누르면 이메일은 아웃룩 메일 서버로 전송된다.
        - 아웃룩 클라이언트 - 메일 서버 프로토콜 = SMTP
    2. 아웃룩 메일 서버는 DNS 질의를 통해 수신자 SMTP 서버 주소를 찾는다.
    3. 찾은 주소의 메일 서버로 이메일을 보낸다. (SMTP)
    4. 지메일 서버는 이메일을 저장하고 수신자 B가 읽어갈 수 있도록 한다.
    5. B가 지메일에 로그인하면 지메일 클라이언트는 IMAP/POP 서버를 통해서 이메일을 가져온다.
- 저장소
    - 파일시스템의 디렉터리에 저장한다.
    - 각 이메일은 고유 이름을 가진 별도 파일로 보관
    - 사용자의 설정 데이터와 메일함은 사용자 디렉터리에 보관
    - Maildir라는 이름의 디렉터리가 널리 사용
    - 문제
        - 이메일 양이 많아지고, 파일 구조가 복잡해지면 디스크 I/O가 병목
        - 이메일을 서버의 파일 시스템에 보관하였으므로 가용성과 안정성 보장 불가
        - 디스크 손상이나 서버 장애 언제든 발생 가능

### 분산 메일 서버

#### 이메일 API

- 모바일 단말 클라이언트를 위한 SMTP/POP/IMAP API
- 송신 측 메일 서버와 수신 측 메일 서버 간 SMTP 통신
- 대화형 웹 기반 이메일 애플리케이션을 위한 HTTP 기반 RESTful API

1. POST `/v1/messages`: To, Tc, Bcc 헤더에 명시된 수신자에게 메시지 전송
2. GET `/v1/folders`: 이메일 계정에 존재하는 모든 폴더를 반환
3. GET `/v1/folders/{folder_id}/messages`: 폴더 내 모든 메시지 반환
4. GET `/v1/messages/{message_id}`: 특정 메시지 모든 정보 반환

#### 분산 메일 서버 아키텍처
