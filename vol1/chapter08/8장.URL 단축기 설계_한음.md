## 8장 URL 단축기 설계

### 문제 이해 및 설계 범위 확정
- URL 단축기가 어떻게 동작해야 하는가
- 트래픽 규모는 어느정도 인가
- 단축 URL의 길이는 어느 정도여야 하는가
- 단축 URL에 포함될 문자에 제한이 있는가
- 단축된 URL을 시스템에서 지우거나 갱신할 수 있는가

### 시스템의 기본적 기능
- 주어진 긴 URL을 짧은 URL로 변환
- 축약된 URL로 요청이 오면 원래 URL로 리다이렉트
- 높은 가용성과 규모 확장성, 그리고 장애 감내가 요구됨

### API 엔드포인트
- URL 단축기는 기본적으로 두개의 엔드포인트 필요로 함
- URL단축용 엔드포인트: 단축할 URL을 인자로 실어서 POST 요청을 보냄
    - 요청: POST /api/v1/data/shorten
- URL 리디렉션용 엔드포인트: 단축 URL에 대해서 요청이 오면 원래 URL로 리디렉션
    - 요청: GET /api/v1/shortUrl

### URL 리디렉션
- 단축 URL을 받은 서버는 그 URL을 원래 URL로 바꿔서 301 응답의 Location 헤더에 담아서 반환
- 301 Permanently Moved: 요청한 페이지가 새 URL로 영구적으로 이동되었음을 나타냄, 브라우저는 이 응답을 캐시해서 다음에 같은 요청이 오면 새 URL로 바로 이동
    - 서버 부하를 줄이는 것이 중요하다면 사용
- 302 Found: 요청한 페이지가 일시적으로 다른 URL로 이동되었음을 나타냄, 브라우저는 언제나 단축 URL 서버에 먼저 요청을 보낸 후 리디렉션함
    - 트래픽 분석할 때 유리

### URL 단축
- 결국 중요한 것은 대응 시킬 해시 함수 fx를 찾는 것
    - 입력으로 주어지는 긴 URL이 다르면 해시 값도 달라야함
    - 계산된 해시 값은 원래 긴 URL로 복원 가능해야함

### 데이터 모델
- 모든 것을 해시 테이블에 두는 것은 곤란한데, 메모리는 유한하고 비싸기 때문
- 따라서 관계형 데이터베이스에 <단축 URL, 원래 URL>을 순서쌍으로 저장하자

### 해시 함수
- hashValue의 길이와 해시 함수가 만들 수 있는 URL 개수 사이의 관계는 이러하다

| n | URL 개수     |
|---|------------|
|1| 62         |
|2| 3,844      |
|3| 238,328    |
|4| 14,776,336 |
|5| 916,132,832|
|6| 56,800,235,584|
|7| 3,521,614,606,208|
|8| 218,340,105,584,896|

- 손쉬운 방법은 CRC32, MD5, SHA-1 등을 사용하는 것
- 그치만 가장 짧은 해시값 조차도 7보다 길다
- 계산 된 해시 값에서 처음 7개만 이용하는 방법이 있다. 다만 충돌 확률이 높아짐
    - 충돌이 해소될 때까지 사전에 정한 문자열을 해시값에 덧붙여야 한다
- base-62 변환을 사용하는 이유는 URL에 사용할 수 있는 문자가 62개이기 때문
    - 0~9, a~z, A~Z
    - 단축 URL의 길이가 가변적이고 ID값이 커지면 같이 길어짐
    - 유일성 보장 ID 생성기가 필요
    - ID의 유일성이 보장된 후 적용 가능해서, 충돌 아예 불가능
    - 다음에 쓸 수 있는 단축 URL이 무엇인지 알 수 있어서 보안상 문제가 될 수 있음

### 추가적으로 논의해볼 것
- 처리율 제한 장치: 엄청난 양의 단축 URL 요청이 들어오면 무력화 될 수 있기 때문에 제한을 두어야 함
- 웹 서버의 규모 확장: 웹 계층은 무상태 계층이므로, 웹 서버를 자유로이 증설 삭제 가능
- 데이터베이스의 규모 확장: 데이터베이스는 다중화 하거나, 샤딩
- 데이터 분석 솔루션: 어떤 링크를 얼마나 많이 클릭했는지 추적할 수 있음
- 가용성, 데이터 일관성, 안정성: 대규모 시스템이 성공하려면 반드시 갖추어야 한다.