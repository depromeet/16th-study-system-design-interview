## 13장 검색어 자동완성 시스템_한음.md

### 문제 이해 및 설계 범위 확정
- 사용자가 입력하는 단어는 자동완성될 검색어의 첫 부분인지 중간 부분인지
- 몇 개의 자동완성 검색어가 표시되어야 하는가
- 자동완성 검색어 N개를 고르는 기준은 무엇인가
- 맞춤법 검사 능도 제공해야하는지
- 질의 언어는 무엇인지
- 대문자나 특수 문자 처리가 필요한지
- 얼마나 많은 사용자를 지원해야 하는가?

### 검색어 자동완성 시스템의 요구사항
- 빠른 응답 속도 : 페이스북 자동완성 시스템 문서를 보면 100밀리초 이내
- 연관성 : 사용자가 입력한 단어와 자동완성 되는 검색어가 연관성이 있어야 함
- 정렬 : 인기도 등의 순위 모델에 의해 정렬되어 있어야 함
- 규모 확장성
- 고가용성

### 개략적 규모 추정
- DAU를 천만명으로 가정
- 한 사용자가 매일 10건, 질의 당 20바이트로 가정
- 대략 초당 24000건의 질의(QPS)가 발생하고, 최대 QPS는 48000건
- 20%가 신규 검색어라고 가정하면 매일 0.4GB의 데이터가 시스템에 추가됨

### 개략적 설계안 제시 및 동의 구하기
- 개략적으로 보면 시스템은 두 부분으로 나뉨
- 데이터 수집 서비스 
  - 사용자가 입력한 질의를 실시간으로 수집하는 시스템
  - 단, 데이터가 많은 애플리케이션에 실스간 시스템은 바람직하지 않음
- 질의 서비스
  - 주어진 질의에 N개의 인기 검색어를 정렬해 내놓는 서비스

### 데이터 수집 서비스
- 질의와 빈도를 저장하는 빈도 테이블이 존재
- 사용자가 검색어를 입력하면 해당 질의의 빈도 수가 증가함

### 질의 서비스
- 빈도 테이블을 이용해 가장 많이 사용된 검색어 N개를 조회하는 SQL 질의문
- `SELECT * FROM frequency_table WHERE query Like prefix% ORDER BY frequency DESC LIMIT N`
- 데이터가 아주 많아지면 데이터베이스가 병목이 될 수 있음

### 상세 설계
- 트라이 자료구조
  - RDB로 가장 인기 있는 N개의 질의문을 골라내는건 효율적이지 않음
  - 트라이는 문자열들을 간략하게 저장할 수 있는 트리 형태의 자료 구조
  - 루트 노드는 빈 문자열, 각 노드는 글자 하나를 저장하며, 다음 글자로 등장할 수 있는 모든 글자를 자식 노드로 가짐
- 데이터 수집 서비스
  - 수천만 건의 질의가 입력될 때마다 트라이를 갱신하면 질의 서비스가 심각하게 느려질것
  - 인기 검색어는 자주 바뀌지 않는다
- 질의 서비스
  - 번개처럼 빨라야 한다

### 트라이 자료구조
- 가장 많이 사용된 질의어 k개를 찾는 과정
  - 접두어를 표현하는 노드를 찾음, 시간 복잡도는 O(p:접두어의 길이)
  - 해당 노드부터 시작하는 하위 트리를 탐색 유효 노드를 찾음, 시간 복잡도는 O(c:주어진 노드의 자식 노드 개수)
  - 유효 노드들을 정렬하여 가장 인기 있는 검색어 k를 찾음, 시간 복잡도는 O(clogc)
- 알고리즘의 시간 복잡도는 O(p) + O(c) + O(clogc)
- 최악의 경우에는 k개 결과를 얻으려고 전체 트라이를 다 검색해야할 수 있음. 해결 방안으로는
  - 접두어의 최대 길이를 제한
  - 각 노드에 인기 검색어를 캐시

### 데이터 수집 서비스
- 수정된 설계안의 컴포넌트
- 데이터 분석 서비스 로그
  - 질의 원본 데이터를 보관
- 로그 취합 서버
  - 서비스에 따라 취합 주기가 달라짐
- 취합된 데이터
- 작업 서버
  - 트라이 자료구조 만들고 트라이 데이터베이스에 저장
- 트라이 캐시
  - 연산 성능을 높이는데, 매주 트라이 데이터베이스의 스냅샷을 떠서 갱신
- 트라이 데이터베이스
  - 주로 몽고 DB, 또는 키-값 저장소

### 질의 서비스
- 다음과 같은 최적화 방안 고민
- AJAX 요청
  - 새로고침 없이 요청 보냄
- 브라우저 캐싱
  - 제안된 검색어를 브라우저 캐시에 넣어두면 후속 질의는 해당 캐시에서 바로 가져갈 수 있음
- 데이터 샘플링

### 트라이 연산
- 트라이 생성 : 작업 서버가 담당하며, 로그나 DB에서 취합된 데이터를 이용
- 트라이 갱신
  - 매주 한번 갱신, 기존 트라이를 새로운 트라이로 대체
  - 각 노드를 개별적으로 갱신하는 방법
- 검색어 삭제 : 트라이 캐시 앞에 필터를 두고 위험한 질의어를 제거함

### 저장소 규모 확장
- 트라이의 크기가 한 서버에 넣기에 너무 크다면?
- 샤딩을 생각해볼 수 있으나 균등하게 배분하기 어려움
- 과거 질의 패턴을 분석하여 샤딩하는 검색어 대응 샤드 관리자 도입



