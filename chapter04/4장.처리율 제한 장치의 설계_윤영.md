# :pushpin: 4장. 처리율 제한 장치의 설계

## 처리율 제한 장치의 설계
- 네트워크 시스템에서 처리율 제한 장치(rate limiter)는 클라이언트 또는 서비스가 보내는 트래픽의 처리율(rate)을 제어하기 위한 장치
- HTTP를 예로 들면 이 장치는 특정 기간 내에 전송되는 클라이언트의 요청 횟수를 제한한다.
- 다음은 몇 가지 사례다.
  - 사용자는 초당 2회 이상 새 글을 올릴 수 없다.
  - 같은 IP 주소로는 하루에 10개 이상의 계정을 생성할 수 없다.
  - 같은 디바이스로는 주당 5회 이상 리워드를 요청할 수 없다.

- 처리율 제한 장치가 있으면 좋은 점
  - DoS(Denial Of Service) 공격에 의한 자원 고갈을 방지
  - 비용을 절감한다. 처리율 제한은 제3자(third-party) API에 사용료를 지불하고 있는 회사들에게는 아주 중요하다.
  - 서버 과부하를 막는다. 봇(bot)에서 오는 트래픽이나 사용자의 잘못된 이용 패턴으로 유발된 트래픽을 걸러내는데 활용할 수 있다.


## 1단계: 문제 이해 및 설계 범위 확정
처리율 제한 장치를 구현하는데는 여러가지 알고리즘을 사용할 수 있는데 그 각각은 고유한 장단점을 갖고 있다.

### 1.1 요구사항
- 설정된 처리율을 초과하는 요청은 정확하게 제한
- HTTP 응답 시간에 나쁜 영향을 주어서는 안된다.
- 가능한 한 적은 메모리를 써야 한다.
- 하나의 처리율 제한 장치를 여러 서버나 프로세스에서 공유할 수 있어야 한다.
- 예외 처리: 요청이 제한되었을 때는 그 사실을 사용자에게 분명하게 보여주어야 한다.
- 높은 결함 감내성: 제한 장치에 장애가 생기더라도 전체 시스템에 영향을 주어서는 안된다.


## 2단계: 개략적 설계안 제시 및 동의 구하기
### 2.1 처리율 제한 장치는 어디에 둘 것인가?
이 장치는 클라이언트에 둘 수도 있고 서버에 둘 수도 있다.

- 클라이언트 측: 일반적으로 클라이언트는 처리율 제한을 안정적으로 걸 수 있는 장소가 못된다. 클라이언트 요청은 쉽게 위변조가 가능하기 때문
- 서버 측: 서버 측에 제한 장치를 두는 방법도 있다.
- 처리율 제한 미들웨어(middleware): 처리율 제한 장치를 API 서버에 두는 대신, 처리율 제한 미들웨어를 만들어 해당 미들웨어로 하여금 API 서버로 가는 요청을 통제하도록 하는 방법

처리율 제한 장치는 어디 두어야 하나? 서버에 두어야 하나 아니면 게이트웨이에 두어야 하나? 정답은 없다.
다만 일반적으로 적용될 수 있는 몇 가지 지침을 나열해보면 다음과 같다.
- 프로그래밍 언어, 캐시 서비스 등 현재 사용하고 있는 기술 스택
- 사업 필요에 맞는 처리율 제한 알고리즘을 찾자
- 설계가 마이크로서비스에 기반하고 있고 사용자 인증이나 IP 허용 목록 관리 등을 처리하기 위해 API 게이트웨이를 이미 설계에 포함시켰다면 처리율 제한 기능 또한 게이트웨이에 포함시키는 것을 고려하자
- 처리율 제한 장치를 구현하기에 충분한 인력이 없다면 상용 API 게이트웨이를 쓰는 것이 바람직하다.

### 2.2 처리율 제한 알고리즘
- 토큰 버킷(token bucket)
- 누출 버킷(leaky bucket)
- 고정 윈도 카운터(fixed window counter)
- 이동 윈도 로그 (sliding window log)
- 이동 윈도 카운터 (sliding window counter)