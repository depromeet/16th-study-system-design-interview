# 분산 이메일 서비스 설계

## 1. 요구사항 정리

### 기능 요구사항
- 이메일 발송/수신
- 전체 이메일 조회
- 읽음 여부 기반 필터링
- 제목, 발신일, 본문 검색 기능
- 스팸 및 바이러스 필터링
- 첨부파일 지원

### 비기능 요구사항
- **안정성**: 이메일 데이터 소실이 없어야 함
- **가용성**: 이메일과 사용자 데이터를 여러 노드에 자동 복제 / 장애 시에도 지속적으로 동작해야 함
- **확장성**: 사용자 수 증가에 따른 수평 확장 가능
- **유연성**: 새로운 컴포넌트의 통합 용이

### 규모 추정
- 사용자 수: 10억
- 하루 평균 이메일 발송 수: 10건 → QPS: 100,000
- 하루 평균 수신 이메일: 40건
- 이메일 메타데이터 평균 크기: 50KB
- 첨부파일 비율: 20%, 평균 크기: 500KB

핵심 : 많은 데이터를 처리해야 한다.
```
1년간 메타데이터 저장: 10억 * 40 * 365 * 50KB = 730PB
1년간 첨부파일 저장: 10억 * 40 * 365 * 20% * 500KB = 1,460PB
```
---

## 2. 개략적 설계

### 이메일 프로토콜
- **SMTP**: 메일 보낼 때만 (POST 느낌)
- **POP**: 메일 받아오고 끝 (GET + DELETE 느낌)
- **IMAP**: 서버랑 계속 연결 (RESTful GET 느낌)
- **HTTPS**: 웹 기반 인터페이스 접속에 사용

### DNS
메일을 보낼 때 수신자 도메인의 MX 레코드(메일 교환기)를 찾기 위해 DNS 사용
> MX : 내 도메인(example.com)으로 메일 보내고 싶으면, 여기 있는 메일 서버로 보내줘

### 전통적 이메일 서버 구조
1. 이메일 작성하고 보내기 버튼 누르면 메일 서버로 이메일 전송(SMTP)
2. 메일서버는 DNS 질의를 통해 수신자 SMTP 서버 주소 찾고 발송(SMTP)
3. 수신 메일 서버는 메일 저장하고 클라이언트는 IMAP/POP 서버를 통해 새 이메일 가져옴

### 분산 이메일 서버 구성
- **웹 서버**: REST API 제공
- **실시간 서버**: 웹소켓 기반 메일 알림 제공
- **메타데이터 DB**: 메일 헤더/상태 등 저장
- **객체 저장소**: 첨부파일 저장
- **분산 캐시**: 최근 이메일 조회 속도 향상
- **검색 저장소**: 역 인덱스 기반 검색 기능 지원

### 주요 API
- `POST /v1/messages`: 이메일 발송
- `GET /v1/folders`: 사용자 폴더 목록 반환
- `GET /v1/folders/{folder_id}/messages`: 폴더 내 메일 목록
- `GET /v1/messages/{message_id}`: 특정 메일 상세 정보

---

## 3. 상세 설계

### 메타데이터 저장소
- **파티션 키**: `user_id`
- **클러스터 키**: `folder_id`, `email_id` (TIMEUUID 사용)
- **요구 질의**:
    - 특정 사용자 모든 폴더 조회
    - 폴더 내 정렬된 메일 조회
    - 읽음 여부 기반 필터링
    - 이메일 생성/삭제
    - 이메일 타래(쓰레드) 가져오기

### 데이터 저장 전략
- 메일 메타데이터와 본문은 별도 저장
- 첨부파일은 객체 스토리지 사용
- **읽음 여부 분리**: `read_emails`, `unread_emails` 테이블 분할 설계

### 일관성 vs 가용성
- 이메일 서비스는 **일관성 우선**
- 장애 발생 시 쓰기 연산 중단, 주 사본 복구 후 복원

### 이메일 전송 가능성
내가 보낸 이메일이 수신자의 받은 편지함까지 도달할 확률
그냥 메일 서버가 받았다는 게 아니라, 스팸함 말고 '정상 수신함'에 꽂히는지 여부까지 포함함.
- 전용 IP 사용 : 내 IP의 평판을 내가 통제 가능/ 다른 유저의 스팸 이력에 영향 없음
- 범주화 : 수신자 그룹을 행동/관심사/이력에 따라 적절히 분류해서 보내야 함
    - 전혀 관련 없는 사람에게 무분별하게 보내면 "불필요한 메일 → 스팸 신고 → 전송 가능성 하락"
- 발신자 평판 : 평판 점수 낮으면 아무리 메일 잘 보내도 수신자 받은편지함에 도달 못함(스팸 신고율, 메일 반송률, 열람률, 클릭률 등)
- 스팸 발송자 신속 차단 : 스팸 많이 보내는 IP는 실시간으로 블랙리스트 등록됨
- 피드백 처리
- 이메일 인증

---

### 검색 시스템
- **ElasticSearch**:
    - 백엔드에서 비동기 색인
    - 카프카로 이벤트 처리 decoupling
- **커스텀 검색 엔진**:
    - LSM 트리 구조 기반
    - 애플리케이션 통합성이 높음

### 맞춤형 검색 엔진
보통 대규모 이메일 서비스에서는 검색 엔진을 자체적으로 개발해 사용함.

검색 솔루션을 구현할 경우 디스크I/O 병목 문제가 주요하게 다뤄질 문제임.



#### [디스크I/O 병목 문제]

메일 저장소에 추가되는 데이터 양은 페타바이트(PB)수준이며, 한 이메일 당 수십만개의 이메일이 저장될 가능성도 높음.

-> 메일 색인 서버의 주된 병목은 디스크I/O

"LSM(Log-Structured Merge)트리"는 다량의 쓰기 연산을 할 때 디스크에 저장되는 색인을 구조화하기에 바람직함.

---

## 4. 추가 고려사항

### 보안
- 메일 암호화 (TLS)
- 피싱 탐지, 스팸 필터링
- 의심 링크 차단
- 기밀 모드, 로그인 경고

### 컴플라이언스
- GDPR 등 법규 준수
- 합법적 감청 대응 (Legal Intercept)

### 결함 내성
- 데이터센터 간 복제
- 큐 기반 처리로 일시적 오류 대응
- 사용자 요청은 가장 가까운 지역으로 라우팅

## 5. 요약

분산 이메일 서비스는 높은 신뢰성과 확장성을 요구하는 시스템이다. SMTP, IMAP 등의 표준 프로토콜과 더불어 REST API를 중심으로 웹 기반 메일 기능을 구현한다. 메일 데이터는 메타데이터, 본문, 첨부파일로 분리 저장되며, 검색과 실시간 기능은 별도의 컴포넌트를 통해 처리된다. ElasticSearch 또는 자체 검색 시스템이 선택 가능하며, 사용자 수가 많을수록 커스텀 솔루션의 필요성이 커진다. 시스템 구성은 웹메일, 큐, 저장소, 검색, 실시간 서버 등으로 분리되며, 각 컴포넌트는 수평 확장이 가능해야 한다.

