## 5장 지표 모니터링 및 경보 시스템

### 문제 이해 및 설계 범위 확정
- 면접관의 요구사항을 알아내는 것이 중요하다
  - 인프라에 관심 있는 면접관 앞에서 로그에 초점을 맞춘 시스템을 만들면 곤란하다
- 다음과 같은 질문으로 요구사항을 알아내자
  - 시스템의 고객은 누구인가?
  - 어떤 지표를 수집해야 하는가?
    - CPU 부하, 메모리 사용률, 디스크 사용량 등의 저수준 지표일 수 도 있고,
    - 초당 요청 수, 웹 서버 프로세스 개수 같은 고차원척 지표일 수 도 있음
  - 인프라 규모는 어느정도 인가?
  - 지표는 얼마나 보관해야 하는가?
  - 데이터를 장기 보관 전용 저장소로 옮길 때 지표의 해상도를 낮추어도 괜찮은가?
  - 경보 채널로는 어떤 것을 지원해야 하는가
  - 에러 로그나 액세스 로그 등에 대한 수집도 제공해야하는가?
  - 분산 시스템 추적 기능을 제공해야 하는가

### 비기능 요구사항
- 규모 확장성 : 늘어나는 지표 수와 경보의 양에 맞게 확장 되어야 한다
- 낮음 응답 지연 시간 : 질의에 대한 낮은 응답 지연을 보장해야함
- 안정성 : 중요 경보를 놓치지 않아야 하니까
- 유연성 : 기술은 계속 변화하므로, 미래의 신기술을 쉽게 통합할 수 있도록 유연하게 변경 가능한 파이프라인을 구축해야 한다

### 지표 모니터링 및 경보 시스템의 일반적인 5가지 컴포넌트
1. 데이터 수집
2. 데이터 전송
3. 데이터 저장소
4. 경보
5. 시각화

### 데이터 모델
- 먼저 기본적인 데이터 모델에 대해 알아보자
- 지표 데이터는 통상 시계열 데이터 형태로 기록된다
  - 타임 스탬프가 붙은 형태로 기록한다는 의미이며, 선택적으로 레이블을 붙인다.

### 데이터 접근 패턴
- 시계열 데이터와 레이블을 기반으로 데이터에 접근
- 이 시스템에서는 단연 쓰기가 압도적이다
- 읽기 부하는 일시적으로 치솟았다가 사라지는 spiky 하다

### 데이터 저장소 시스템
- 본 설계안의 핵심이다
- 저장소 시스템을 직접 설계 하거나 MySQL 같은 저장소를 이용하는 것을 추천하지 않는다
- 범용 데이터베이스로 규모를 맞추려면 전문가 수준의 튜닝이 필요하기 때문
- 특히 RDBMS는 시계열 연산에 최적화 되어있지 않다
- 태그 레이블에 대한 질의를 지원하려면 태그마다 인덱스를 지정해야하기 때문
- 카산드라나 빅테이블 같은 NoSQL도 확장이 용이한 설계를 위해서는 NoSQL 내부에 대한 해박한 지식이 필요하다
- 시장에서 가장 인기 있는 시계열 데이터베이스 두가지는 InfluxDB, 프로메테우스
  - 다량의 시계열 데이터를 저장하고 빠른 실시간 분석을 지원함
  - 메모리 캐시와 디스크 저장소를 함께 사용
  - 영속성 요건과 높은 성능 요구사항도 잘 만족함
- 좋은 시계열 데이터베이스는 막대한 양의 시계열 데이터를 레이블 기준으로 집계하고 분석하는 기능을 제공함

### 상세 설계
- 다음 주제에 대해 더 알아보자
  - 지표 수집
  - 지표 전송 파이프라인의 규모 확장
  - 질의 서비스
  - 저장소 계층
  - 경보 시스템
  - 시각화 시스템

### 지표 수집
- 카운터나 CPU 사용량 같은 지표를 수집할 때는 데이터가 소실되어도 아주 심각한 문제는 아니다
- 지표 데이터 수집 방법에는 두가지 모델이 있다
  - 풀모델
  - 푸시모델
- 어느 쪽이 더 나은지에 대한 정답은 없음

### 풀 모델
- 애플리케이션에서 주기적으로 지표 데이터를 가져오는 지표 수집기가 흐름의 중심이다
- etcd나 주키퍼 같은 서비스 탐색 기술을 활용하여, 자신의 가용정 정보를 SDS에 기록하고, 지표 수집기에 통보.
- 문제점
  - 지표 수집기를 여러대 둘 때 여러 서버가 같은 출처에서 데이터를 중복해서 가져올 가능성이 있다
  - 한가지 방안은 해시링을 사용, 해시 링 구간마다 해당 구간에 속한 서버로부터 생산되는 지표의 수집을 담당하는 수집기 서버를 지정한다

### 푸시 모델
- 지표 출처에 해당하는 서버가 직접 수집기에 전송하는 모델
- 모니터링 대상 서버의 수집 에이전트가 주기적으로 수집기에 지표 데이터를 전달.
- 이 때 집계되는 데이터의 양이 방대하다면, 수집기가 전송되는 데이터를 처리하지 못할 수도 있음.
- 그래서 지표 수집기 클러스터 자체도 오토스케일링이 가능하도록 구성하고 앞에 LB를 두는게 바람직

### 풀 모델과 푸시 모델의 비교
- 풀 모델을 채택한 사례로 프로메테우스가 있다
- 푸시 모델을 채택한 사례로 클라우드워치와 그래파이트가 있다
- 면접에서는 두 모델의 장단점을 비교할 수 있는 능력을 보이는 것이 중요함

### 지표 전송 파이프라인의 규모 확장
- 시게열 데이터베이스에 장애가 생기면 데이터 손실이 발생할 가능성이 있다
- 카프카 같은 큐를 두면 그런 문제를 해소할 수 있다
- 장점
  - 데이터 수집 컴포넌트와 처리 컴포넌트 사이의 결합도를 낮춘다
  - 데이터베이스에 장애가 생겨도 데이터를 카프카에 보관하면 된다
- 면접관이 카프카 도입을 반대할 수 있는데, 고릴라 같은 큐 없이 대규모 데이터 처리가 가능한 모니터링 시스템 제안할 수 있음

### 데이터 집계 지점
- 수집 에이전트가 집계하는 방안
- 데이터 수집 파이프라인에서 집계하는 방안
- 질의 시에 집계하는 방안

### 질의 서비스
- 질의 서비스는 시각화 또는 경보 시스템에서 접수된 요청을 시계열 데이터베이스를 통해 처리하는 역할을 담당
- 대부분의 상용 시각화 및 경보 시스템은 이미 시계열 데이터베이스와의 연동을 처리하는 플러그인 갖추고 있으므로, 도입 여부를 잘 고려해야함
- 하지만 시각화 - 시계열 데이터베이스 간 결합도를 낮추고 싶다면 질의 서비스를 별도로 구축하는 것도 방법

### 저장소 계층
- 지표 모니터링 시스템에 저장할 데이터의 양은 방대하다
- 이 문제를 공략하는 몇가지 전략
  - 데이터 인코딩 및 압축 : 좋은 시계열 데이터베이스는 내장
  - 다운 샘플링 : 해상도를 낮춰 보관 (30일 데이터 -> 1분 해상도)
  - 냉동 저장소

### 경보 시스템
- 개략적으로 다음과 같은 플로우
  - 경보 관리자는 지정된 시간 마다 질의하여, 임계값을 위반하면 경보 이벤트를 생성, 카프카로 전달
  - 카프카에서 이벤트를 읽어서, 이메일, 페이저듀티, 알림 채널 등으로 전송

### 시각화 시스템
- 시각화 시스템은 구현하기 어렵기 때문에 상용품을 구입해서 쓰는게 바람직
- 그라파나를 사용하면 좋다



