# 5장: **안정 해시(Consistent Hashing) 설계**

## 1. 해시 키 재배치(Rehash) 문제
`serverIndex = hash(key) % N`

-> 일반적으로 N개의 캐시 서버가 있을 때 부하를 균등하게 분배하는 방법
but 이 방식은 서버 개수가 고정되어 있거나 데이터 분포가 균등할 때는 잘 동작하지만, **서버 추가나 제거 시**에 아래와 같은 문제가 발생한다.

### 문제점:
1. 서버가 추가 또는 삭제되면 기존 키의 해시 값이 변동됨
    - 예를 들어, 기존 4대 서버에서 5대로 확장하면 `hash(key) % 4 → hash(key) % 5`가 되어 기존 키들이 엉뚱한 서버로 이동하게 됨.
    - 대부분의 캐시 데이터가 유실되어 대규모 캐시 미스 발생

2. **트래픽이 몰리면 균형을 유지하기 어려움**
    - 특정 서버에 과도한 요청이 집중될 가능성이 있음(핫스팟 키 문제)

-> 이 문제를 해결하기 위해 **안정 해시** 기법이 사용된다.

---

## 2. 안정 해시
안정 해시는 **서버 개수가 변경되더라도 최소한의 키만 재배치되도록 설계된 해시 기법**이다.
- 평균적으로 `전체 키 개수/전체 서버 개수`의 키만 재배치 됨(슬롯 수가 바뀌면 거의 대부분의 키를 재배치하는 전통적 해시 테이블과의 차이점이 있음)


---

## 3. 해시 링
해시 공간을 원형 구조(링)로 만들어 각 서버를 배치하는 방식.

### **동작 방식**
1. 해시 공간을 원형 링으로 변환
2. 각 서버의 IP 또는 고유한 식별자(서버 이름)를 해시링에 배치
3. 각 키도 해시링 위에 배치(% 연산 사용 x)
4. 키를 저장할 서버를 결정할 때, 시계 방향으로 이동하여 처음 만나는 서버에 저장

이렇게 하면 서버를 추가/제거 하더라도 키 가운데 일부만 재배치하면 된다.
하지만 이 경우에는 두 가지 문제점이 발생한다.

1. 파티션의 크기를 균등하게 유지할 수 없음
    - 각 서버는 굉장히 작은 해시 공간을 할당 받고, 다른 서버는 굉장히 큰 해시 공간을 할당 받을 수 있음
    - 파티션 : 인접한 서버 사이의 해시 공간

2. 키 균등 분포 달성이 어려움
    - 특정 서버가 너무 많은 키를 가지거나, 일부 서버는 아무 키도 가지지 않을 수 있음.

이 문제를 해결하기 위해 **가상 노드(Virtual Node)** 개념이 도입되었다.

---

## 6. 가상 노드
가상 노드는 **실제 서버를 대신하여 여러 개의 논리적 노드를 해시링에 배치하는 기법**이다.

### 동작 방식
1. **각 서버에 여러 개의 가상 노드를 할당**
    - 예를 들어, 서버 S0가 있다면 `S0_1, S0_2, S0_3`처럼 여러 개의 가상 노드를 해시링에 배치.
2. **가상 노드를 통해 해시링에서의 분포를 균등하게 조정**
    - 특정 서버에 과도한 키가 몰리는 현상을 방지

### 장점
- 가상 노드 개수를 늘릴수록 **키의 분포가 더욱 균등해짐**.
- **표준 편차 감소**
    - 가상 노드 100개 → 표준 편차 약 10%
    - 가상 노드 200개 → 표준 편차 약 5%

### 단점
- 가상 노드 정보가 많아질수록 **추가 저장 공간이 필요**함.

---

## 7. 추가 설명
- **레디스에서 데이터 샤딩 시 안정 해시를 사용할 수 있음**.
- **Consistent Hashing을 기반으로 한 로드 밸런서**(ex: Nginx, Envoy)에서도 활용됨.
- **분산 데이터 저장소**(ex: Cassandra, DynamoDB)에서도 안정 해시를 사용하여 노드 간 데이터를 균등하게 분산.



