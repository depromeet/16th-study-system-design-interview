## 6장 광고 클릭 이벤트 집계

### 개요
- 이번 장에서는 페이스북이나 구글 규모에 걸맞는 광고 클릭 이벤트 집계 시스템을 설계해볼 것
- 디지털 광고의 핵심 프로세스는 RTB, 실시간 경매라고 부름
- 보통 1초 내에 모든 프로세스가 마무리되고, 광고로 나갈 지면이 결정됨
- 속도와 정확성이 중요하고, 클릭률 전환률 등을 기반으로 계산해야함

### 문제 이해 및 설계 범위 확정
- 다음과 같은 질문을 할 수 있다
  - 입력된 데이터의 형태와 양은 어떻게 되는지
  - 가장 중요하게 지원해야할 질의는 무엇인지
  - 엣지 케이스는 무엇인지
  - 지연 시간 요건은 어떤지

### 비기능 요구사항
- 집계 결과의 정확성이 매우 중요
  - RTB 및 광고 과금에 사용되기 때문
- 지연되거나 중복된 이벤트를 적절히 처리할 수 있어야 함
- 부분적인 장애를 감내할 수 있는 견고성
- 지연 시간 요구사항을 넘기지 않아야 함

### 개략적 설계안 제시 및 동의 구하기
- 다음 내용을 살펴볼 것
  - 질의 API
  - 데이터 모델
  - 비동기 처리

### 질의 API 설계
- 본 설계안의 클라이언트는 데이터 과학자, 제품 관리자 광고주
- 그들이 대시보드를 이용하는 순간 다음과 같은 질의 발생
  - 지난 M분 동안 각 ad_id에 발생한 클릭 수 집계
  - 지난 M분 동안 가장 클릭이 많이 발생한 상위 N개 ad_id 목록 반환
  - 다양한 속성을 기준으로 필터링

### 데이터 모델
- 이 시스템은 원시 데이터와 집계 결과 데이터 두가지를 다룸
- 원시 데이터를 저장하는 방안과 집계 결과 데이터만 보관하는 방안 중 무엇이 적절한다?
  - 둘 다 저장할 것을 추천한다
- 그 이유는 다음과 같다
  - 문제가 발생하면 디버깅에 활용하도록 원시 데이터를 보관하는 것이 좋다
  - 질의는 원시 데이터가 아닌 집계 데이터에 하여 효율성 개선
  - 원시 데이터는 백업 데이터로 활용하도록 냉동 저장소로 옮기면 된다

### 비동기 처리
- 개략적 설계안은 데이터를 동기식으로 처리하고 있다.
- 트래픽이 갑자기 증가하면, 특정 컴포넌트에 장애가 발생할 수 있고 이는 전체 시스템 장애로 이어진다
- 이 문제를 해결하는 방안은 카프카 같은 메시지 큐를 도입하여 비동기 방식으로 동작하게 하는 것
- 이를 해결한 설계안에는 두 개의 메시지 큐가 있다.
  - 설계안에서 집계 결과를 데이터베이스에 바로 기록하지 않는 이유는, 정확하게 한 번 데이터를 처리하기 위함
  - 그래서 카프카를 두 번째 메시지 큐로 둠

### 집계 서비스
- 광고 클릭 이벤트를 집계하는 좋은 방안 하나는 맵리듀스 프레임워크를 사용하는 것
- 이 모델은 작은 컴퓨팅 단위로 세분화하여 각 노드 한 가지 작업만 처리하게 함
  - 맵 노드 : 데이터 출처에서 읽은 데이터를 필터링하고 변환
  - 집계 노드 : ad_id별 광고 클릭 이벤트 수를 매 분 메모리에서 집계
  - 리듀스 노드 : 모든 집계 노드가 산출한 결과를 최종 결과로 축약
- 예를 들어 사례 2 가장 많이 클릭된 상위 N개 광고 반환
  - 맵 노드: 이벤트에서 광고 데이터를 가져옴
  - 집계 노드: 힙을 사용해서 상위 3개 광고를 식별
  - 리듀스 노드: 전달 받은 9개 광고 중 1분간 가장 많이 클릭된 4개를 골라냄

### 상세 설계
- 다음 항목들을 더욱 자세히 살펴본다
  - 스트리밍 vs 일괄 처리
  - 시간과 집계 윈도
  - 전달 보장
  - 시스템의 규모 확장
  - 데이터 모니터링 및 정확성
  - 최종 설계 다이어그램
  - 결함 내성

### 스트리밍 vs 일괄 처리
- 본 설계안은 스트림 처리와 일과 처리 방식을 모두 사용하는데, 이를 람다라고 부름
  - 두 가지 경로를 모두 지원하므로 유지 관리 코드가 늘어남
- 카파 아키텍처는 일괄 처리와 스트리밍 처리 경로를 하나로 결합한 것

### 시간과 집계 윈도
- 집계하려면 타임스탬프가 필요한데 이때 이벤트 시각과 처리 시각 둘 중 하나의 타임 스탬프를 사용할 수 있다
- 데이터 정확도는 아주 중요하므로, 책에서는 이벤트 발생 시각을 추천함
  - 이 경우 시스템에 늦게 도착한 이벤트는 어떻게 처리할까
  - 워터마크를 이용하여 해결한다
  - 다만, 데이터의 정확도는 높아지지만 지연시간이 늘어날 수 있음
- 텀블링 윈도와 슬라이딩 윈도를 살펴보자
  - 텀블링 윈도 : 시간을 분할, 매분 발생한 클릭 이벤트를 집계 적합
  - 슬라이딩 윈도 : 겹칠 수 있음. M분간 가장 많이 클릭된 광고 알아내기에 적합

### 전달 보장

