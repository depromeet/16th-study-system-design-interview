## 14장 유튜브 설계

### 문제 이해 및 설계 범위 확정
- 유튜브의 모든 기능을 45분에서 60분 가량 진행되는 면접 시간에 설계하는 것은 불가능하다
- 어떤 기능, 어떤 클라이언트를 지원해야 하는가
- 일단 능동 사용자 수는 몇명이고, 평균적으로 소비하는 시간은 어느정도 인가
- 어떤 해상도를 지원해야하는지, 파일 크기에 제한이 있는지
- 클라우드 서비스를 이용해도 되는가

### 개략적 설게안 제시 및 동의 구하기
- 왜 전부 직접 만들지 않는가?
- 주어진 시간 안에 적절한 기술을 골라 설계를 마치는 것이, 그 기술이 어떻게 각각 동작하는지 설명하는 것보다 중요함
- BLOB 저장소나 CDN 만드는 것은 지극이 복잡하고 많은 비용이 드는 일. 넷플릭스 페이스북도 스스로 구축하지 않음
- 시스템의 컴포넌트 구성
  - 사용자 단말
  - CDN : 비디오를 저장, 스트리밍
  - API 서버 : 비디오 스트리밍 제외한 모든 요청을 처리

### 비디오 업로드 절차
1. 비디오를 원본 저장소에 업로드
   - 단말은 병렬적으로 비디오 메타데이터 갱신 요청을 API 서버에 보냄
2. 트랜스코딩 서버는 원본 저장소에서 비디오를 가져와 트랜스코딩을 시작
3. 완료된 비디오를 트랜스 코딩 비디오 저장소로 업로드 + 이벤트를 트랜스 코딩 완료 큐에 넣음
4. API 서버가 단말에게 비디오 업로드가 끝남을 알림

### 비디오 스트리밍 절차
- 비디오 스트리밍이 이루어지는 절차를 논하기에 앞서 스트리밍 프로토콜에 대해 알아보자
- 프로토콜의 동작 원리를 이해하거나 외울 필요는 없음
- 기억해야하는 것은 프로토콜마다 지원하는 비디오 인코딩이 다르고 플레이어도 다르다는 것
- 비디오는 CND에서 바로 스트리밍 되므로 전송 지연은 아주 낮음

### 상세 설계
- 비디오 트랜스코딩
- 유향 비순환 그래프(DAG) 모델
- 비디오 트랜스코딩 아키텍처
- 시스템 최적화
- 오류 처리

### 비디오 트랜스코딩
- 비디오 트랜스코딩이 중요한 이유
  - 가공되지 않은 원본 비디오는 저장 공간을 많이 차지함
  - 호환상 문제를 해결하러면 하나의 비디오를 여러 포맷으로 인코딩해야함
  - 네트워크 대역폭이 충분한 사용자와 그렇지 않은 사용자에게도 비디오 재생을 보장
  - 비디오 화질을 변경할 수 있게 해야함
- 인코딩 포맷 구성
  - 컨테이너 : 비디오, 오디오, 메타데이터를 담는 바구니 (.avi, mov, mp4)
  - 코덱 : 비디오 화질은 보존하며 파일 크기를 줄일 목적으로 고안된 압축 알고리즘

### 유향 비순환 그래프(DAG) 모델
- 각기 다른 비디오 프로세싱 파이프라인을 지원하며 병렬성을 높일 필요가 있음
- 페이스북의 비디오 엔진은 DAG 모델을 도입함
- 검사, 비디오 인코딩, 섬네일, 워터마크 등의 작업 수행

### 비디오 트랜스코딩 아키텍처
- 전처리기 : 비디오 분할, DAG 생성, 데이터 캐시
- DAG 스케줄러 : DAG 그래프를 단계로 분할한 다음 작업 큐에 집어 넣음
- 자원 관리자 : 자원 배분을 효과적으로 수행
- 작업 서버 : DAG에 정의된 작업을 수행, 종류에 따라 서버도 구분하여 관리
- 임시 저장소 : 메타데이터는 메모리에 캐시, 비디오는 BLOB 저장소에 저장

### 시스템 최적화
- 비디오 병렬 업로드 : GOP로 분할하여 병렬로 업로드, 이렇게 하면 일부 업로드가 실패해도 빠르게 재업할 수 있음
- 업로드 센터를 사용자 근거리에 지정
- 모든 절차를 병렬화 : 메시지 큐를 도입하여 보관된 이벤트를 병렬적으로 처리
- 미리 사인된 업로드 URL : 허가 받는 사용자만이 올바른 장소에 업로드하기 위해 presigned-url 이용
- 비디오 보호 : 디지털 저작권 관리 시스템 도입, AES 암호화, 워터마크 도입
- 비용 최적화
  - 인기 비디오는 CDN으로 그렇지 않은 비디오는 비디오 서버에서 재생
  - 짧은 비디오는 필요할 때 인코딩
  - 특정 지역에만 인기가 높은 비디오는 다른 지역에 옮길 필요 없음

### 오류 처리
- 회복 가능 오류 : 재시도 하고 계속 실패하면 적절한 오류 코드 반환
- 회복 불가능 오류 : 작업 중단하고 오류코드 반환
- 다른 서버에서 작업을 재시도 하거나 교체하는 방안을 검토