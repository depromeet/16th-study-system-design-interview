# **뉴스 피드 시스템 설계**

## **1. 문제 이해 및 설계 범위 확정**
### **뉴스 피드 개요**
- 페이스북, 인스타그램, 트위터 등의 소셜 네트워크에서 사용되는 핵심 기능
- 사용자의 상태 업데이트, 사진, 비디오, 링크, 앱 활동 등이 포함됨
- 면접 질문으로 자주 출제되는 시스템 설계 문제

### **요구 사항**
- **지원 플랫폼**: 모바일(iOS, Android) 및 웹
- **핵심 기능**:
    - 사용자가 새로운 피드를 게시할 수 있어야 함
    - 사용자는 친구의 피드를 최신 순으로 볼 수 있어야 함
- **정렬 기준**: 시간 역순 (최신 게시물이 위로 정렬)
- **친구 수 제한**: 최대 5,000명
- **트래픽 규모**: 하루 1,000만 명의 활성 사용자(DAU)
- **미디어 포함 여부**: 이미지 및 비디오 지원

---

## **2. 개략적 설계**
### **피드 발행 (Feed Publishing)**
1. 사용자가 스토리를 작성하면 데이터베이스와 캐시에 저장
2. 새로운 포스팅은 친구들의 뉴스 피드에도 전송

### **뉴스 피드 생성 (News Feed Building)**
1. 친구들의 모든 포스팅을 시간 역순으로 정렬하여 제공

### **API 설계**
- **피드 발행 API**
    - `POST /v1/me/feed` + body

- **피드 읽기 API**
    - `GET /v1/me/feed` + body
      <img width="564" alt="image" src="https://github.com/user-attachments/assets/7c16c161-5202-4295-8b09-1c891dada318" />

---

## **3. 상세 설계**
### **피드 발행 흐름**
1. 사용자가 클라이언트(모바일 앱, 웹)에서 포스팅을 생성
2. API 요청을 웹 서버로 전달 (로드 밸런서 사용)
3. 웹 서버에서 인증 및 요청 처리
4. 포스팅 저장 서비스(Post Service)에서 데이터베이스 및 캐시에 저장
5. 포스팅 전송 서비스(Fan-out Service)가 친구들의 뉴스 피드에 업데이트
6. 알림 서비스(Notification Service)가 친구들에게 새 포스팅을 알림

<img width="724" alt="image" src="https://github.com/user-attachments/assets/280b7583-d4c7-44c8-8ce8-8b4e7c71f258" />

### **뉴스 피드 생성 흐름**
1. 사용자가 뉴스 피드를 요청 (`GET /v1/me/feed`)
2. API 요청이 웹 서버로 전달
3. 웹 서버가 뉴스 피드 서비스 호출
4. 뉴스 피드 캐시에서 피드 ID 목록 조회
5. 사용자 정보, 포스팅 내용, 미디어 파일 조회
6. 완성된 피드를 JSON 형태로 반환하여 클라이언트가 렌더링

<img width="541" alt="image" src="https://github.com/user-attachments/assets/25462bbc-fc9b-4d7d-8f49-cdbc855a462b" />

### **팬 아웃(Fan-out) 모델**
- **쓰기 시점 팬 아웃 (Fan-out on Write)**
    - 포스팅이 생성될 때 모든 친구의 뉴스 피드를 즉시 업데이트
    - **장점**: 피드를 빠르게 로드 가능
    - **단점**: 친구 수가 많은 사용자는 업데이트 비용이 높음

- **읽기 시점 팬 아웃 (Fan-out on Read)**
    - 사용자가 피드를 요청할 때 최신 포스팅을 조회
    - **장점**: 비활성 사용자에게 불필요한 연산을 수행하지 않음
    - **단점**: 피드를 불러오는 데 시간이 걸릴 수 있음

#### **혼합 모델 적용**
  - **쓰기 시점 팬 아웃(Fan-out on Write) + 읽기 시점 팬 아웃(Fan-out on Read) 결합**
  - **대부분 사용자**: 푸시 모델 사용 (쓰기 시점 팬 아웃)
  - **팔로워가 많은 사용자**: 풀 모델 사용 (읽기 시점 팬 아웃)
  - **Consistent Hashing**을 활용하여 데이터 균등 분산 → 핫 키(Hot Key) 문제 방지

##### **팬 아웃 서비스 동작 과정**
<img width="300" alt="image" src="https://github.com/user-attachments/assets/d044abcb-295e-43f5-bcef-9ed9d93b6d8a" />

1. **친구 ID 조회**
   - 그래프 데이터베이스에서 친구 목록을 가져옴.

2. **사용자 정보 필터링**
   - 사용자 캐시에서 친구 정보를 조회.
   - 알림 설정(mute) 여부 등을 반영하여 필터링.

3. **메시지 큐에 포스팅 ID 저장**
   - 친구 목록과 함께 메시지 큐에 새 포스팅 ID를 추가.

4. **팬 아웃 작업 서버에서 뉴스 피드 캐시에 저장**
   - 메시지 큐에서 데이터를 가져와 뉴스 피드 캐시에 저장.
   - `〈포스팅 ID, 사용자 ID〉` 형태의 매핑 테이블을 유지.

##### **메모리 최적화**
  - **전체 사용자 정보 및 포스팅 데이터를 캐시에 저장하지 않음** → 메모리 사용량 최소화
  - **캐시 크기 제한 설정** → 불필요한 메모리 낭비 방지
  - **최신 스토리 중심 저장** → 대부분 사용자는 최신 포스팅만 조회하므로 캐시 미스(Cache Miss) 확률 감소

---

## **4. 캐시 구조**
- **뉴스 피드 캐시**: 사용자별 피드 ID 저장
- **콘텐츠 캐시**: 포스팅 데이터 저장 (인기 콘텐츠와 일반 콘텐츠 분리)
- **소셜 그래프 캐시**: 친구 및 팔로우 정보 저장
- **행동 데이터 캐시**: 좋아요, 댓글 등의 사용자 활동 기록
- **카운터 캐시**: 좋아요 개수, 댓글 개수, 팔로워 수 등 저장

<img width="400" alt="image" src="https://github.com/user-attachments/assets/ea8e2d8c-0e2d-49b1-bc73-e187cb2214b1" />

---

## **5. 확장성 및 최적화 고려 사항**
### **데이터베이스 확장**
- **수직적 확장 vs 수평적 확장**: 트래픽 증가에 대비하여 샤딩(Sharding) 고려
- **SQL vs NoSQL**: 관계형 DB와 비관계형 DB 혼합 사용 가능
- **마스터-슬레이브 복제**를 이용한 읽기 부하 분산

### **캐싱 전략**
- 데이터베이스 부하 감소를 위해 **메모리 캐시(Redis, Memcached) 사용**
- CDN(Content Delivery Network)을 활용하여 이미지, 비디오 파일 제공 속도 최적화

### **메시지 큐 도입**
- 뉴스 피드 업데이트를 비동기적으로 처리하여 시스템 부하 분산

### **보안 및 속도 개선**
- 인증 및 권한 제어 (`Authorization Token`)
- 트래픽이 많을 경우 **전송률 제한(Rate Limiting)** 적용
- 데이터센터 분산 운영 고려

---

## **6. 결론**
- 뉴스 피드 시스템은 **쓰기 성능과 읽기 성능의 균형**이 중요
- **혼합된 팬 아웃 모델(Fan-out on Write & Fan-out on Read)** 사용하여 성능 최적화
- **메시지 큐, 캐시, 데이터베이스 샤딩**을 적극 활용하여 확장성 보장
- 사용자의 피드 경험을 개선하기 위해 **전송률 제한, 추천 알고리즘** 등을 추가 가능

면접에서 뉴스 피드 시스템 설계를 설명할 때는, **트래픽 규모, 확장성, 최적화 전략**을 중심으로 논의하는 것이 중요하다.
