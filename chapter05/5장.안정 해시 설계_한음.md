## 5장 안정 해시 설계

### 해시 키 재배치(Rehash) 문제
- N개의 캐시 서버에 부하를 균등하게 나누는 보편적 방법은 해시 함수를 쓰는 것
- 서버 풀의 크기가 고정되어 있고, 데이터 분포가 균등할 때는 잘 동작
- 서버가 추가되거나 삭제되면 문제가 생김, 계산한 서버 인덱스 값이 달라지니까
- 대규모 캐시 미스가 발생할 것이다

### 안정 해시
- 해시 테이블 크기가조정될 때 평균적으로 k/n개의 키만 재배치하는 방법
- k는 키의 개수, n은 슬롯의 크기

### 해시링
- 해시 공간의 양쪽을 구부려 접으면 해시 링이 만들어진다
- 서버 ip나 이름을 링 위에 대응 시킬 수 있고, 캐시할 키 또한 링 위에 배치할 수 있다
- 어떤 키가 저장되는 서버는, 시계 방향으로 링을 탐색해 나가면서 만나는 첫번째 서버
- 서버가 추가되거나 삭제되어도, 기존 키의 대부분은 그대로 유지되고, 일부만 재배치 된다 (그림5-8)

### 기본 구현법의 문제 두가지
- 서버가 추가되거나 삭제 되는 상황에서 파티션의 크기를 균등하게 유지하는 것이 불가능
- 키의 균등 분포가 어려운데, 아무 데이터도 갖지 않는 서버, 대부분의 키를 가진 서버가 생길 수 있다
- 이를 해결하기 위해 가상 노드 또는 복제(replica) 기법 사용

### 가상 노드
- 각 실제 서버에 여러 개의 가상 노드를 할당
- 서버0을 배치하기 위해 S0_0, S0_1, S0_2와 같이 세 개의 가상 노드를 사용
- 가상 노드의 개수를 늘리면, 해시 공간이 더 균등하게 분배된다
- 하지만 가상 노드를 저장할 공간이 더 많이 필요하게 된다.