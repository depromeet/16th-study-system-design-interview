# 10장. 알림 시스템 설계
## 목표
고객에게 중요할 만한 정보를 비동기적으로 제공하는 알림 시스템을 설계하라.
- 종류
  - 푸시 알림
  - SMS
  - 이메일
## 1단계. 문제 이해 및 설계 범위 확정
- 지원해야할 알림 종류: 푸시 알림, SMS 메시지, 이메일
- 실시간 시스템이어야 하는가: 연성 실시간 시스템 (알림은 가능한 빨리 전달되어야 하지만 시스템에 높은 부하가 걸렸을 때 약간의 지연은 무방)
- 지원 단말 종류: iOS 단말, 안드로이드 단말, 랩톱/데스크톱
- 알림 생성 주체: 클라이언트 애플리케이션 프로그램 or 서버 측 스케줄링
- 알림 받지 않음 설정 지원 여부: 지원
- 하루 전송 알림 건수: 천만 건의 모바일 푸시 알림, 백만 건의 SMS 메시지, 5백만 건의 이메일
## 2단계. 개략적 설계안 제시 및 동의 구하기
- 알림 유형별 지원 방안
- 연락처 정보 수집 절차
- 알림 전송 및 수신 절차
### 1) 알림 유형별 지원 방안
#### iOS 푸시 알림
> 알림 제공자 => APSN => iOS 단말
- 알림 제공자: 알림 요청 만들어서 APNS에 보내는 주체
  - 단말 토큰: 알림 요청 보내기 위한 고유 식별자
  - 페이로드: 알림 내용 담은 JSON 딕셔너리
- APNS(Apple Push Notification Service): 애플 제공 원격 서비스, 푸시 알림을 iOS 장치로 보내는 역할
- iOS 단말: 푸시 알림 수신하는 사용자 단말
#### 안드로이드 푸시 알림
> 알림 제공자 => FCM(Firebase Cloud Message) => 안드로이드 단말
#### SMS 메시지
> 알림 제공자 => SMS 서비스 => SMS 수신 단말
- SMS 서비스: Twilio, Nexmo 같은 제3의 상용 서비스 (비용 부과)
#### 이메일
> 알림 제공자 => 이메일 서비스 => 이메일 수신 단말
- 이메일 서비스: 고유 이메일 서버 구축 or Sendgrid, Mailchimp 같은 사용 서비스
### 2) 연락처 정보 수집 절차
- 푸시 알림, SMS 메시지, 이메일 모두 지원해야하므로 관련 사용자의 정보를 수집하여 DB에 저장
- user:device = 1:N 고려하여 테이블 설계
### 3) 알림 전송 및 수신 절차
#### 개략적 설계안(초안)
<img alt="image" src="https://github.com/user-attachments/assets/8612550a-3236-414e-9487-11817afd93eb">

#### 개략적 설계안(개선안)
<img alt="image" src="https://github.com/user-attachments/assets/60974441-be37-4ba2-a4dd-7b3996638278">

## 3단계. 상세 설계
### 안정성
#### 1) 데이터 손실 방지
- 알림 지연 or 순서 변경은 ok, 손실 not ok
- 데이터를 DB에 보관 및 재시도 메커니즘 구현
- ex) 작업 서버에 알림 로그 DB 유지
#### 2) 알림 중복 전송 방지
- 중복 탐지 메커니즘 도입, 오류 신중하게 처리
- ex) 보내야 하는 알림 이벤트의 ID를 검사하여 처리한 적 있는 이벤트인지 검증
### 추가 고려사항
- 알림 템플릿: 템플릿을 사용하여 전송될 알림들의 형식을 일관성 있게 유지 -> 오류 & 알림 작성 시간 감소
- 알림 설정: 사용자에게 알림 설정 권한 부여
- 전송률 제한: 사용자가 받을 수 있는 알림 빈도 제한
- 재시도 메커니즘: 전송 실패 시 재시도 전용 큐에 적재, 문제 반복 시 개발자에게 알림
- 보안: 인증된/승인된 클라이언트만 알림 전송 API 사용
- 큐 모니터링: 큐에 쌓인 알림의 개수 모니터링하여 작업 서버 증설
- 이벤트 추적: 데이터 분석 시스템을 통해 알림 확인율, 클릭율, 실제 앱 사용으로 이어지는 비율 등의 메트릭 수집
### 수정된 설계안

<img alt="image" src="https://github.com/user-attachments/assets/343eddd6-77fa-4dc1-b408-dabed5af9f34">

## 4단계. 마무리
### 추가 고민지점
- 각 레벨 별 재시도 전략 구체화
- 메세지큐 종류별 동작 방식 비교
- 재시도 작업 큐에 적재하는 기준 구체화
